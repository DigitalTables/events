<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DigitalTables – Gestion des tables invités</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <div class="container">
    <div class="logo-title">
      <img src="images/Logo.jpg" alt="Logo DigitalTables" class="logo" />
      <h1>DigitalTables</h1>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h2>Attribuez facilement la table de vos invités</h2>
    <p>Un outil simple et rapide qui apporte une touche unique à votre événement.</p> 
  </div>
</section>

<div style="text-align:center; margin-top:1rem;">
  <button id="logout" style="display:none;">Se déconnecter</button>
</div>

<!-- Section Auth -->
<div id="auth" style="text-align:center; margin-top:2rem;">
  <h3>Connexion / Inscription</h3>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Mot de passe" />
  <button id="signup">Créer un compte</button>
  <button id="login">Se connecter</button>
</div>

<!-- Section Upload -->
<div id="upload" style="display:none; text-align:center; margin-top:2rem;">
  <div style="margin-bottom:1rem;">
    <label for="username" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Choisissez un identifiant public (visible dans l’URL) :
    </label>
    <input type="text" id="username" placeholder="ex: johanna-martin-2026" />
    <div id="usernameStatus" style="margin-top:0.25rem; font-size:0.9rem;"></div>
  </div>

  <div style="margin-bottom:1rem;">
    <label>
      <input type="checkbox" id="privateCsv" /> CSV privé (accès via mot de passe)
    </label>
  </div>

  <div id="passwordDiv" style="display:none; margin-bottom:1rem;">
    <label for="eventPassword" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Mot de passe de l’événement :
    </label>
    <input type="password" id="eventPassword" placeholder="Mot de passe de l’événement" />
  </div>

  <h3>Uploader ton CSV et tes images</h3>
  <input type="file" id="guests" accept=".csv" /><br><br>

  <div id="tablesImagesContainer">
    <p>Associez vos images aux tables :</p>
    <div id="tableImageRows"></div>
    <button id="addTableImageRow">Ajouter une table/image</button>
  </div>

  <br>
  <button id="send">Envoyer CSV</button>
  <button id="createSheet">Créer Google Sheet</button>

  <div id="publicUrl" style="margin-top:1rem; font-size:0.9rem; word-break:break-all;"></div>
</div>

<!-- Section Dashboard -->
<div id="dashboard" style="display:none; margin-top:3rem; padding: 0 2rem;">
  <h3 style="text-align:center; margin-bottom:1rem;">Vos événements</h3>
  <div id="eventsContainer" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem;"></div>
</div>

<footer>
  <div class="container">
    <p>© 2025 DigitalTables. Tous droits réservés.</p>
  </div>
</footer>

<script type="module">
import { supabase, getPrivateCsv, SUPABASE_URL } from './supabase.js';
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";

const authDiv = document.getElementById("auth");
const uploadDiv = document.getElementById("upload");
const logoutBtn = document.getElementById("logout");
const email = document.getElementById("email");
const password = document.getElementById("password");
const signup = document.getElementById("signup");
const login = document.getElementById("login");
const sendBtn = document.getElementById("send");
const createSheetBtn = document.getElementById("createSheet");
const csvInput = document.getElementById("guests");
const usernameInput = document.getElementById("username");
const usernameStatus = document.getElementById("usernameStatus");
const privateCsvCheckbox = document.getElementById("privateCsv");
const passwordDiv = document.getElementById("passwordDiv");
const eventPasswordInput = document.getElementById("eventPassword");
const publicUrlDiv = document.getElementById("publicUrl");
const tableImageRows = document.getElementById("tableImageRows");
const addTableImageRowBtn = document.getElementById("addTableImageRow");
const dashboardDiv = document.getElementById("dashboard");

// Toggle mot de passe si CSV privé
privateCsvCheckbox.addEventListener("change", () => {
  passwordDiv.style.display = privateCsvCheckbox.checked ? "block" : "none";
});

// Connexion / déconnexion
function onLogin() {
  authDiv.style.display = "none";
  uploadDiv.style.display = "block";
  logoutBtn.style.display = "inline-block";
  dashboardDiv.style.display = "block";
  loadUserUploads();
}
function onLogout() {
  authDiv.style.display = "block";
  uploadDiv.style.display = "none";
  logoutBtn.style.display = "none";
  publicUrlDiv.textContent = "";
  dashboardDiv.style.display = "none";
}

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  onLogout();
};

supabase.auth.getSession().then(({ data }) => {
  if (data.session) onLogin();
  else onLogout();
});
supabase.auth.onAuthStateChange((_event, session) => {
  if (session) onLogin();
  else onLogout();
});

// Authentification
signup.onclick = async () => {
  const { data, error } = await supabase.auth.signUp({ email: email.value, password: password.value });
  if (error) return alert("Erreur : " + error.message);
  const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
  if (loginError) return alert("Erreur login : " + loginError.message);
  onLogin();
  alert("✅ Compte créé et connecté !");
};
login.onclick = async () => {
  const { error } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
  if (error) alert("Erreur : " + error.message);
  else onLogin();
};

// Vérifie si pseudo déjà utilisé
async function checkPublicJsonExists(username) {
  const { data, error } = await supabase.storage.from("public-guests").list("", { search: `guests_${username}.json` });
  if (error) return false;
  return data.some(f => f.name === `guests_${username}.json`);
}

usernameInput.addEventListener("blur", async () => {
  const username = usernameInput.value.trim();
  if (!username) { usernameStatus.textContent = ""; return; }
  const exists = await checkPublicJsonExists(username);
  usernameStatus.textContent = exists ? "❌ Pseudo déjà utilisé" : "✅ Disponible";
  usernameStatus.style.color = exists ? "red" : "green";
});

// Gestion des lignes table → image
function addTableImageRow() {
  const div = document.createElement("div");
  div.style.marginBottom = "0.5rem";
  div.innerHTML = `
    <input type="text" placeholder="Nom de la table" style="width: 200px; margin-right:0.5rem;" />
    <input type="file" accept="image/*" />
    <button type="button" class="removeRow">❌</button>
  `;
  div.querySelector(".removeRow").onclick = () => div.remove();
  tableImageRows.appendChild(div);
}
addTableImageRowBtn.addEventListener("click", addTableImageRow);

// ---- UPLOAD CSV ----
sendBtn.onclick = async () => {
  // ... le code reste identique à ton upload CSV actuel
  // (voir le script fourni précédemment)
};

// ---- CRÉER GOOGLE SHEET ----
createSheetBtn.onclick = async () => {
  // ... le code reste identique à celui fourni précédemment
};

// Dashboard
async function loadUserUploads() {
  // ... le code reste identique à celui fourni précédemment
}
</script>
</body>
</html>
