<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DigitalTables ‚Äì Gestion des tables invit√©s</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header>
  <div class="container">
    <div class="logo-title">
      <img src="images/Logo.jpg" alt="Logo DigitalTables" class="logo" />
      <h1>DigitalTables</h1>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h2>Attribuez facilement la table de vos invit√©s</h2>
    <p>Import CSV ou Google Sheet ‚Ä¢ √âv√©nement public ou priv√©</p>
  </div>
</section>

<div style="text-align:center; margin-top:1rem;">
  <button id="logout" style="display:none; max-width:300px;">Se d√©connecter</button>
</div>

<!-- ================= AUTH ================= -->
<section id="auth">
  <div class="container" style="max-width:480px;">
    <h3 style="text-align:center;">Connexion / Inscription</h3>

    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Mot de passe" />

    <button id="signup">Cr√©er un compte</button>
    <button id="login">Se connecter</button>
  </div>
</section>


<!-- ================= DASHBOARD ================= -->
<section id="dashboard" style="display:none;">
  <div class="container">
    <h3 style="text-align:center;">Mes √©v√©nements</h3>
    <div id="eventsContainer" class="dashboard-grid"></div>
  </div>
</section>



 <!-- ================= CREATE EVENT ================= -->
<section id="upload" style="display:none;">
  <div class="container" style="max-width:720px;">

    <h3 style="text-align:center;">Cr√©er un √©v√©nement</h3>

    <label>Identifiant public (URL)</label>
    <input type="text" id="username" placeholder="ex : mariage-anne-2026" />
    <div id="usernameStatus" class="hint"></div>

    <hr style="margin:2rem 0;">

    <strong>Visibilit√© de l‚Äô√©v√©nement</strong>
    <label style="display:block; margin-top:0.5rem;">
      <input type="checkbox" id="privateCsv" />
      √âv√©nement priv√© (acc√®s par mot de passe)
    </label>

    <div id="passwordDiv" style="display:none; margin-top:0.75rem;">
      <input type="password" id="eventPassword" placeholder="Mot de passe de l‚Äô√©v√©nement" />
    </div>

    <hr style="margin:2rem 0;">

    <strong>Source des invit√©s</strong>

    <div class="mode-selector">
      <label>
        <input type="radio" name="mode" id="modeCsv" checked />
        üìÑ Import CSV
      </label>
      <label>
        <input type="radio" name="mode" id="modeSheet" />
        üìä Google Sheet
      </label>
    </div>

    <h4 id="uploadTitle">Importer votre fichier CSV</h4>
    <input type="file" id="guests" accept=".csv" />

    <hr style="margin:2rem 0;">

    <!-- ===== IMAGES OPTIONNELLES ===== -->
    <h4>Images par table (optionnel)</h4>
    <p style="font-size:0.9rem; color:#6b5a4a;">
      Vous pouvez associer une image √† certaines tables (facultatif).
    </p>

    <div id="tableImageRows"></div>

    <button
      id="addTableImageRow"
      style="max-width:260px; margin-bottom:2rem;"
    >
      ‚ûï Ajouter une table
    </button>

    <!-- ===== ACTION PRINCIPALE ===== -->
    <hr style="margin:2.5rem 0;">

    <div style="text-align:center;">
      <p style="font-weight:600; margin-bottom:0.5rem;">
        Une fois tout pr√™t :
      </p>

      <button
        id="createEventBtn"
        style="max-width:360px; font-size:1.1rem;"
      >
        ‚úÖ Cr√©er l‚Äô√©v√©nement
      </button>
    </div>

    <div id="publicUrl" class="hint" style="margin-top:1rem; text-align:center;"></div>

  </div>
  

  
<footer>
  <div class="container">
    <p>¬© 2026 DigitalTables. Tous droits r√©serv√©s.</p>
  </div>
</footer>
  
</section>

  
<!-- ================= SCRIPT ================= -->
<script type="module">
import { supabase, SUPABASE_URL, getPrivateCsv } from './supabase.js';
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";
/* ================= GESTION CONFIRMATION EMAIL ================= */

/**
 * G√®re la confirmation d'email apr√®s clic sur le lien
 * Supporte √† la fois les formats hash (#) et query (?)
 */
async function handleEmailConfirmation() {
  // Extraire les param√®tres de l'URL (hash et query)
  const hashParams = new URLSearchParams(window.location.hash.substring(1));
  const queryParams = new URLSearchParams(window.location.search);
  
  // Chercher le token dans hash ou query
  const access_token = hashParams.get('access_token') || queryParams.get('token');
  const type = hashParams.get('type') || queryParams.get('type');
  const refresh_token = hashParams.get('refresh_token');
  
  console.log('üîç D√©tection confirmation email:', { access_token: !!access_token, type });
  
  // Si c'est une confirmation d'email
  if (access_token && type === 'signup') {
    console.log('üìß Traitement de la confirmation email...');
    
    try {
      // M√©thode 1 : Utiliser setSession (recommand√© pour les liens magiques)
      const { data, error } = await supabase.auth.setSession({
        access_token,
        refresh_token: refresh_token || ''
      });
      
      if (error) {
        console.error('‚ùå Erreur setSession:', error);
        
        // M√©thode 2 : Fallback avec verifyOtp
        const { data: otpData, error: otpError } = await supabase.auth.verifyOtp({
          token_hash: access_token,
          type: 'signup'
        });
        
        if (otpError) throw otpError;
        
        console.log('‚úÖ Email confirm√© via OTP:', otpData);
        alert('‚úÖ Email confirm√© avec succ√®s ! Bienvenue !');
      } else {
        console.log('‚úÖ Email confirm√© via setSession:', data);
        alert('‚úÖ Email confirm√© avec succ√®s ! Vous √™tes maintenant connect√©.');
      }
      
      // Nettoyer l'URL (enlever les param√®tres)
      window.history.replaceState({}, document.title, window.location.pathname);
      
      // Forcer un rafra√Æchissement de l'√©tat d'auth
      await supabase.auth.refreshSession();
      
    } catch (error) {
      console.error('‚ùå Erreur confirmation email:', error);
      alert(`‚ùå Erreur lors de la confirmation : ${error.message}\n\nLe lien a peut-√™tre expir√©. Veuillez cr√©er un nouveau compte.`);
      
      // Nettoyer l'URL m√™me en cas d'erreur
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  }
}

// ‚ö†Ô∏è IMPORTANT : Appeler cette fonction AVANT tout autre code
handleEmailConfirmation();
  
/* ================= DOM ================= */
const authDiv = document.getElementById("auth");
const uploadDiv = document.getElementById("upload");
const dashboardDiv = document.getElementById("dashboard");
const logoutBtn = document.getElementById("logout");

const email = document.getElementById("email");
const password = document.getElementById("password");
const signup = document.getElementById("signup");
const login = document.getElementById("login");

const createEventBtn = document.getElementById("createEventBtn");
const csvInput = document.getElementById("guests");
const usernameInput = document.getElementById("username");
const usernameStatus = document.getElementById("usernameStatus");
const privateCsvCheckbox = document.getElementById("privateCsv");
const passwordDiv = document.getElementById("passwordDiv");
const eventPasswordInput = document.getElementById("eventPassword");
const publicUrlDiv = document.getElementById("publicUrl");
const tableImageRows = document.getElementById("tableImageRows");
const addTableImageRowBtn = document.getElementById("addTableImageRow");
const modeCsv = document.getElementById("modeCsv");
const modeSheet = document.getElementById("modeSheet");
const uploadTitle = document.getElementById("uploadTitle");
let editingEvent = null; // contiendra l‚Äôevent si √©dition

/* ================= UI ================= */
privateCsvCheckbox.onchange = () => {
  passwordDiv.style.display = privateCsvCheckbox.checked ? "block" : "none";
};

function updateModeUI() {
  if (modeCsv.checked) {
    uploadTitle.textContent = "Importer votre fichier CSV";
    csvInput.style.display = "block";
  } else {
    uploadTitle.textContent = "Les invit√©s seront g√©r√©s via Google Sheet";
    csvInput.style.display = "none";
  }
}
modeCsv.onchange = updateModeUI;
modeSheet.onchange = updateModeUI;
updateModeUI();

/* ================= AUTH ================= */
supabase.auth.getSession().then(({ data }) => {
  data.session ? onLogin() : onLogout();
});
supabase.auth.onAuthStateChange((_e, s) => {
  s ? onLogin() : onLogout();
});

function onLogin() {
  authDiv.style.display = "none";
  uploadDiv.style.display = "block";
  logoutBtn.style.display = "inline-block";
  dashboardDiv.style.display = "block";
  loadUserUploads().then(enforceEventLimit);
}

function onLogout() {
  authDiv.style.display = "block";
  uploadDiv.style.display = "none";
  logoutBtn.style.display = "none";
  dashboardDiv.style.display = "none";
}

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
};

/* ================= SIGNUP / LOGIN ================= */
signup.onclick = async () => {
  const emailValue = email.value.trim();
  const passwordValue = password.value.trim();
  
  if (!emailValue || !passwordValue) {
    return alert("‚ùå Veuillez remplir tous les champs.");
  }
  
  // Validation email
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(emailValue)) {
    return alert("‚ùå Email invalide.");
  }
  
  // Validation mot de passe
  if (passwordValue.length < 6) {
    return alert("‚ùå Le mot de passe doit contenir au moins 6 caract√®res.");
  }
  
  signup.textContent = "Cr√©ation du compte...";
  signup.disabled = true;
  
  try {
    const { data, error } = await supabase.auth.signUp({
      email: emailValue,
      password: passwordValue,
      options: {
        emailRedirectTo: window.location.origin + window.location.pathname,
        // Donn√©es additionnelles optionnelles
        data: {
          full_name: '', // Vous pouvez ajouter un champ nom si n√©cessaire
        }
      }
    });
    
    if (error) throw error;
    
    // V√©rifier si l'email existe d√©j√†
    if (data?.user?.identities?.length === 0) {
      alert('‚ùå Cet email est d√©j√† utilis√©. Essayez de vous connecter.');
      return;
    }
    
    // V√©rifier si la confirmation est requise
    if (data.user && !data.session) {
      // Confirmation email requise
      alert(`‚úÖ Compte cr√©√© avec succ√®s !

üìß Un email de confirmation a √©t√© envoy√© √† :
${emailValue}

Veuillez v√©rifier votre bo√Æte mail (et vos spams) et cliquer sur le lien pour activer votre compte.

‚è±Ô∏è Le lien expire dans 24 heures.`);
    } else if (data.session) {
      // Pas de confirmation requise ou auto-login
      alert('‚úÖ Compte cr√©√© et connect√© !');
    }
    
    // R√©initialiser les champs
    email.value = '';
    password.value = '';
    
  } catch (error) {
    console.error('Erreur signup:', error);
    alert('‚ùå Erreur : ' + error.message);
  } finally {
    signup.textContent = "Cr√©er un compte";
    signup.disabled = false;
  }
};

login.onclick = async () => {
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) alert(error.message);
};

  function checkEmailConfirmation() {
  supabase.auth.getUser().then(({ data: { user }, error }) => {
    if (user && !user.email_confirmed_at) {
      // Email non confirm√©
      const banner = document.createElement('div');
      banner.style.cssText = `
        background: #fff3cd;
        border: 2px solid #ffc107;
        padding: 1rem;
        margin: 1rem auto;
        max-width: 600px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
      `;
      banner.innerHTML = `
        ‚ö†Ô∏è Votre email n'est pas encore confirm√©.
        <br>
        V√©rifiez votre bo√Æte mail (${user.email}) pour activer votre compte.
        <br>
        <button id="resendConfirmation" style="margin-top:0.5rem;">
          üìß Renvoyer l'email
        </button>
      `;
      
      document.querySelector('header').after(banner);
      
      // Bouton pour renvoyer l'email
      document.getElementById('resendConfirmation').onclick = async () => {
        try {
          const { error } = await supabase.auth.resend({
            type: 'signup',
            email: user.email
          });
          
          if (error) throw error;
          alert('‚úÖ Email de confirmation renvoy√© !');
        } catch (err) {
          alert('‚ùå Erreur : ' + err.message);
        }
      };
    }
  });
}

// Appeler apr√®s login
function onLogin() {
  authDiv.style.display = "none";
  uploadDiv.style.display = "block";
  logoutBtn.style.display = "inline-block";
  dashboardDiv.style.display = "block";
  loadUserUploads().then(enforceEventLimit);
  
  // ‚úÖ AJOUT
  checkEmailConfirmation();
}


/* ================= USERNAME CHECK ================= */
async function checkUsernameExists(username) {
  const { data, error } = await supabase
    .from("events")
    .select("user_id")
    .eq("username", username)
    // ‚úÖ On ne filtre PAS par deleted, on v√©rifie tous les √©v√©nements
    .maybeSingle();

  if (error) {
    console.error(error);
    return true; 
  }

  return !!data;
}

usernameInput.onblur = async () => {
  const u = usernameInput.value.trim();
  if (!u) return usernameStatus.textContent = "";
  const exists = await checkUsernameExists(u);
  usernameStatus.textContent = exists ? "‚ùå Identifiant d√©j√† utilis√©" : "‚úî Disponible";
  usernameStatus.style.color = exists ? "red" : "green";
};


/* ================= DASHBOARD ================= */
async function loadUserUploads() {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return;

  const { data: events } = await supabase
    .from("events")
    .select("*")
    .eq("user_id", user.id)
    .eq("deleted", false);

  const container = document.getElementById("eventsContainer");
  container.innerHTML = "";

  // ‚úÖ Afficher ou masquer la section de cr√©ation selon les √©v√©nements existants
  const hasEvents = events && events.length > 0;
  
  if (hasEvents) {
    uploadDiv.style.display = "none";
    dashboardDiv.style.display = "block";
  } else {
    uploadDiv.style.display = "block";
    dashboardDiv.style.display = "block";
    container.textContent = "Aucun √©v√©nement pour l'instant.";
    return;
  }

  // Afficher les √©v√©nements existants
  for (const e of events) {
    const card = document.createElement("div");
   

const title = document.createElement("h4");
title.textContent = e.username;

const eventLink = document.createElement("a");
eventLink.href = `/events/tables.html?event=${e.username}`;
eventLink.target = "_blank";
eventLink.textContent = "Lien √©v√©nement";

card.appendChild(title);
card.appendChild(eventLink);

if (e.google_sheet_url) {
  const sheetLink = document.createElement("a");
  sheetLink.href = e.google_sheet_url;
  sheetLink.target = "_blank";
  sheetLink.textContent = "üìä Google Sheet";
  card.appendChild(sheetLink);
}
if (e.updated_at) {
  const updatedAtInfo = document.createElement("div");
  updatedAtInfo.textContent = "‚è∞ Derni√®re modification : " + formatDateWithTimeZone(e.updated_at);
  updatedAtInfo.style.fontSize = "0.85rem";
  card.appendChild(updatedAtInfo);
}

const editBtn = document.createElement("button");
editBtn.textContent = "‚úèÔ∏è Modifier";
editBtn.onclick = () => {
  editingEvent = e;
  enterEditMode(e);
};
card.appendChild(editBtn);


    /* SYNC PRIVATE SHEET */
if (e.google_sheet_url && e.is_private) {
  const syncOneBtn = document.createElement("button");
  syncOneBtn.textContent = "Sync Google sheet priv√©e";

  syncOneBtn.onclick = async () => {
    const session = await supabase.auth.getSession();
    const accessToken = session.data.session?.access_token;
    if (!accessToken) return alert("‚ùå Connecte-toi.");

    syncOneBtn.textContent = "Sync...";
    syncOneBtn.disabled = true;

    try {const res = await fetch(
  `${SUPABASE_URL}/functions/v1/sync-privatesheet-csv`,
  {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${accessToken}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      event_id: e.id,
      username: e.username,
      google_sheet_url: e.google_sheet_url,
      password: e.event_password
    })
  }
);
  

      let data = {};
      try {
        data = JSON.parse(await res.text());
      } catch {}

      if (!res.ok) throw new Error(data.error || "Unknown sync error");

      alert("‚úÖ Google Sheet synchronis√©e !");

await supabase
  .from("events")
  .update({
    last_sheet_sync_at: new Date().toISOString()
  })
  .eq("id", e.id);


await loadUserUploads().then(enforceEventLimit);


    } catch (err) {
      alert("‚ùå Sync error : " + err.message);
    } finally {
      syncOneBtn.textContent = "Sync Google sheet priv√©e";
      syncOneBtn.disabled = false;
    }
  };

  card.appendChild(syncOneBtn);

 if (e.last_csv_sync_at) {
  const csvInfo = document.createElement("div");
  csvInfo.textContent =
    "üìÑ Dernier CSV : " + formatDateWithTimeZone(e.last_csv_sync_at);
  csvInfo.style.fontSize = "0.85rem";
  card.appendChild(csvInfo);
}

if (e.last_sheet_sync_at) {
  const sheetInfo = document.createElement("div");
  sheetInfo.textContent =
    "üìä Derni√®re Google Sheet : " + formatDateWithTimeZone(e.last_sheet_sync_at);
  sheetInfo.style.fontSize = "0.85rem";
  card.appendChild(sheetInfo);
}

}


    const deleteBtn = document.createElement("button");
deleteBtn.className = "danger";
deleteBtn.textContent = "üî• Supprimer d√©finitivement";

deleteBtn.onclick = async () => {
  if (!confirm("Supprimer d√©finitivement ?")) return;

  deleteBtn.textContent = "Suppression...";
  deleteBtn.disabled = true;

  const { error } = await supabase
    .from("events")
    .update({ deleted: true })
    .eq("id", e.id);

  if (error) {
    alert("‚ùå Erreur suppression : " + error.message);
    deleteBtn.disabled = false;
    deleteBtn.textContent = "üî• Supprimer d√©finitivement";
    return;
  }

  // ‚úÖ SORTIE PROPRE
  exitEditMode();
  await loadUserUploads();
  await enforceEventLimit();
};


card.appendChild(deleteBtn);


    container.appendChild(card);
  }
}


 
/* ================= TABLE IMAGES ================= */
function addTableImageRow(tableName = "", existingImagePath = null) {
  const div = document.createElement("div");
  div.style.marginBottom = "0.5rem";

  if (existingImagePath) {
    div.dataset.existingImage = existingImagePath;
  }

  function escapeHtml(str) {
    if (!str) return "";
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  // On r√©cup√®re le nom du fichier existant si disponible
  const existingFileName = existingImagePath
    ? existingImagePath.split("/").pop()
    : "";

  div.innerHTML = `
    <input type="text" placeholder="Nom de la table" value="${escapeHtml(tableName)}" />
    <input type="file" accept="image/*" />
    <span class="existing-file-name">${existingFileName}</span>
    <button type="button">‚ùå</button>
  `;

  // Si l‚Äôutilisateur choisit un nouveau fichier, mettre √† jour l‚Äôaffichage du nom
  const fileInput = div.querySelector("input[type='file']");
  const fileNameSpan = div.querySelector(".existing-file-name");
  fileInput.onchange = () => {
    if (fileInput.files[0]) {
      fileNameSpan.textContent = fileInput.files[0].name;
    }
  };

  div.querySelector("button").onclick = () => div.remove();
  tableImageRows.appendChild(div);
}

addTableImageRowBtn.onclick = () => addTableImageRow();


async function uploadImagesMapping(username, existingMapping = {}) {
  const rows = tableImageRows.querySelectorAll("div");
  const mapping = {};

  for (const row of rows) {
    const tableInput = row.querySelector("input[type='text']");
    const fileInput = row.querySelector("input[type='file']");

    if (!tableInput) continue;

    const tableName = tableInput.value.trim();
    if (!tableName) continue;

    const file = fileInput?.files?.[0];

    // üü¢ Cas 1 : aucune nouvelle image ‚Üí on garde l‚Äôexistante
    if (!file) {
      if (row.dataset.existingImage) {
        mapping[tableName] = row.dataset.existingImage;
      }
      continue;
    }

    // üü¢ Cas 2 : nouvelle image ‚Üí upload
    const safeTableName = tableName
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9-_]/g, "-");

    const extension = file.name.split(".").pop();
    const filePath = `${username}/${safeTableName}.${extension}`;

    const { error } = await supabase.storage
      .from("images")
      .upload(filePath, file, { upsert: true });

    if (error) {
      throw new Error("Erreur upload image table : " + error.message);
    }

    mapping[tableName] = filePath;
  }

  return mapping;
}

  
/* Create event */
createEventBtn.onclick = async () => {
  const isEditing = !!editingEvent;
  

  if (isEditing && !editingEvent.is_private && privateCsvCheckbox.checked) {
    return alert("‚ùå Un √©v√©nement public ne peut pas devenir priv√©. Supprime-le et recr√©e-en un.");
  }

  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return alert("‚ùå Connecte-toi.");

  const username = usernameInput.value.trim();
  if (!username) return alert("‚ùå Choisis un identifiant public.");

  const isPrivate = privateCsvCheckbox.checked;
  const eventPassword = eventPasswordInput.value.trim();

if (!editingEvent && isPrivate && !eventPassword) {
  return alert("‚ùå D√©finis un mot de passe pour l‚Äô√©v√©nement priv√©.");
}


  const mode = modeCsv.checked ? "csv" : "sheet";

  let imagesMapping = {};
  try {
    imagesMapping = await uploadImagesMapping(
  username,
  editingEvent?.images_mapping || {}
);

  } catch (e) {
    return alert(e.message);
  }

  /* CSV MODE */
  if (mode === "csv") {
    const csvFile = csvInput.files[0];
    if (!csvFile) return alert("‚ùå Choisis un fichier CSV.");

    createEventBtn.textContent = "Cr√©ation en cours...";
    createEventBtn.disabled = true;

    try {
      const text = await csvFile.text();
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      const rows = parsed.data;

      const csvPath = `guests_${username}.csv`;
      const { error: csvUpErr } = await supabase.storage
        .from("guests")
        .upload(csvPath, new Blob([text], { type: "text/csv" }), { upsert: true });
      if (csvUpErr) throw new Error("Erreur upload CSV: " + csvUpErr.message);

      let publicOrSignedUrl = null;
      if (!isPrivate) {
        const publicJson = `guests_${username}.json`;
        const jsonBlob = new Blob([JSON.stringify(rows, null, 2)], { type: "application/json" });
        const { error: jsonUpErr } = await supabase.storage.from("public-guests")
          .upload(publicJson, jsonBlob, { upsert: true });
        if (jsonUpErr) throw new Error("Erreur upload JSON: " + jsonUpErr.message);
        publicOrSignedUrl = `${SUPABASE_URL}/storage/v1/object/public/public-guests/${publicJson}`;
      }

      const eventObj = {
        username,
        event_password: isPrivate ? eventPassword : null,
        signed_url: publicOrSignedUrl,
        is_private: isPrivate,
        user_id: user.id,
        uploaded_at: new Date().toISOString(),
        images_mapping: imagesMapping
      };
      let event_id = editingEvent?.id;

      if (isEditing) {
        // ‚úèÔ∏è UPDATE √©v√©nement existant
        const { error } = await supabase
          .from("events")
          .update({
            signed_url: publicOrSignedUrl,
            images_mapping: imagesMapping,
            google_sheet_url: null,
            updated_at: new Date().toISOString()
          })
          .eq("id", editingEvent.id);
        if (error) throw error;
      } else {
        // ‚ûï CR√âATION √©v√©nement
        const { data: insertedEvent, error } = await supabase
          .from("events")
          .insert(eventObj)
          .select()
          .single();
        if (error) throw error;
        event_id = insertedEvent.id;
      }

      const eventUrl = `${window.location.origin}/events/tables.html?event=${encodeURIComponent(username)}`;
      publicUrlDiv.innerHTML = isPrivate
        ? `üîí √âv√©nement priv√© cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</a></strong>`
        : `üåç √âv√©nement public cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</a></strong> <br><code>${publicOrSignedUrl}</code>`;

      await supabase
  .from("events")
  .update({
    last_csv_sync_at: new Date().toISOString()
  })
  .eq("id", event_id);

alert("‚úÖ Fichier CSV correctement envoy√© !");

loadUserUploads().then(enforceEventLimit);


    } catch (err) {
      alert("‚ùå Erreur cr√©ation √©v√©nement CSV : " + (err.message || err));
    } finally {
      createEventBtn.textContent = "Cr√©er l'√©v√©nement";
      createEventBtn.disabled = false;
    }
  }

  /* SHEET MODE */
  else {
    createEventBtn.textContent = "Cr√©ation Google Sheet...";
    createEventBtn.disabled = true;

    try {
      const eventObj = {
        username,
        event_password: isPrivate ? eventPassword : null,
        signed_url: null,
        is_private: isPrivate,
        user_id: user.id,
        uploaded_at: new Date().toISOString(),
        images_mapping: imagesMapping
      };
      let event_id = editingEvent?.id;

      if (isEditing) {
        // ‚úèÔ∏è UPDATE √©v√©nement existant
        const { error } = await supabase
          .from("events")
          .update({
            images_mapping: imagesMapping,
            updated_at: new Date().toISOString()
          })
          .eq("id", editingEvent.id);
        if (error) throw error;
      } else {
        // ‚ûï CR√âATION √©v√©nement
        const { data: insertedEvent, error } = await supabase
          .from("events")
          .insert(eventObj)
          .select()
          .single();
        if (error) throw error;
        event_id = insertedEvent.id;

        // ‚úÖ assign-google-sheet uniquement lors de la cr√©ation
        const session = await supabase.auth.getSession();
        const accessToken = session.data.session?.access_token;
        if (!accessToken) throw new Error("Token introuvable, reconnecte-toi.");

        const res = await fetch(
          `${SUPABASE_URL}/functions/v1/assign-google-sheet`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              username,
              user_id: user.id,
              event_id,
              is_public_event: !isPrivate
            })
          }
        );

        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || JSON.stringify(data));

        const sheetEditUrl = `https://docs.google.com/spreadsheets/d/${data.sheet_id}/edit`;
        const publicCsvUrl = data.is_public_event
          ? `https://docs.google.com/spreadsheets/d/${data.sheet_id}/gviz/tq?tqx=out:csv&sheet=Invit√©s`
          : null;

       await supabase
  .from("events")
  .update({
    google_sheet_url: sheetEditUrl,
    signed_url: publicCsvUrl || null,
    updated_at: new Date().toISOString(),
    last_sheet_sync_at: new Date().toISOString()  
  })
  .eq("id", event_id);

        publicUrlDiv.innerHTML = `
          üìä Google Sheet cr√©√©e : <br>
          <a href="${sheetEditUrl}" target="_blank">${sheetEditUrl}</a>
          ${publicCsvUrl ? `<br><code>${publicCsvUrl}</code>` : ""}
        `;
        alert("‚úÖ Google Sheet assign√©e !");
      }
    } catch (err) {
      alert("‚ùå Erreur cr√©ation Google Sheet : " + (err.message || err));
    } finally {
      createEventBtn.textContent = "Cr√©er l'√©v√©nement";
      createEventBtn.disabled = false;
    }
  }
};

/* Edit Mode */
function enterEditMode(event) {
  uploadDiv.style.display = "block";
  createEventBtn.disabled = false;  // activer le bouton
  usernameInput.value = event.username;
  usernameInput.disabled = true;

  privateCsvCheckbox.checked = event.is_private;
  passwordDiv.style.display = "none"; // mot de passe non modifiable

  eventPasswordInput.value = "";

  modeCsv.checked = !event.google_sheet_url;
  modeSheet.checked = !!event.google_sheet_url;
  updateModeUI();

  publicUrlDiv.innerHTML = "‚úèÔ∏è Modification de l‚Äô√©v√©nement existant";

  // Recharger images existantes
  tableImageRows.innerHTML = "";
  if (event.images_mapping) {
    for (const table in event.images_mapping) {
      addTableImageRow(table, event.images_mapping[table]);

    }
  }

  createEventBtn.textContent = "üíæ Enregistrer les modifications";
}

  
/* ================= LIMIT ================= */
async function enforceEventLimit() {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return;
  
  const { data: events } = await supabase
    .from("events")
    .select("id")
    .eq("user_id", user.id)
    .eq("deleted", false);

  // ‚úÖ Gestion s√©curis√©e : si events est null/undefined, on consid√®re 0 √©v√©nements
  const eventCount = events?.length || 0;
  createEventBtn.disabled = eventCount >= 1;
  
  console.log(`Events count: ${eventCount}, Button disabled: ${createEventBtn.disabled}`);
}
  

 /* Format pour la date d'update */
function formatDateWithTimeZone(dateString) {
  if (!dateString || dateString === '') {
    return 'Date non disponible';
  }
  
  try {
    const date = new Date(dateString);
    
    if (isNaN(date.getTime())) {
      console.warn('‚ö†Ô∏è Date invalide:', dateString);
      return 'Date invalide';
    }
    
    return new Intl.DateTimeFormat('fr-FR', {
      timeZone: 'Europe/Paris',
      year: 'numeric',
      month: 'numeric',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      timeZoneName: 'short'
    }).format(date);
  } catch (error) {
    console.error('Erreur formatage date:', error, 'pour:', dateString);
    return 'Date invalide';
  }
}



  /* Exit Edit Mode */
  function exitEditMode() {
  editingEvent = null;

  usernameInput.disabled = false;
  usernameInput.value = "";

  privateCsvCheckbox.checked = false;
  passwordDiv.style.display = "none";
  eventPasswordInput.value = "";

  tableImageRows.innerHTML = "";
  publicUrlDiv.innerHTML = "";

  createEventBtn.textContent = "Cr√©er l'√©v√©nement";
}
  
/* const syncPoolBtn = document.getElementById("syncPoolBtn");

syncPoolBtn.addEventListener("click", syncGoogleSheetsPool);
 */ 
  
  /* Sync google sheet pool */
async function syncGoogleSheetsPool() {
  const { data: session } = await supabase.auth.getSession();
  const token = session.session?.access_token;

  if (!token) {
    alert("‚ùå Connecte-toi");
    return;
  }

  const res = await fetch(
    `${SUPABASE_URL}/functions/v1/sync-googlesheets-pool`,
    {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      }
    }
  );

  const data = await res.json();

  if (!res.ok) {
    console.error(data);
    alert("‚ùå Erreur sync pool");
    return;
  }

  alert(`‚úÖ Pool synchronis√© (${data.pool_count} disponibles)`);
}


</script>

</body>
</html>
