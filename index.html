<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>DigitalTables - Tableau de bord</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Quicksand", sans-serif;
      background: radial-gradient(ellipse at center, #fffdfb 0%, #f5eee5 100%);
      color: #3e2f27;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1, h2 {
      font-family: "Playfair Display", serif;
      color: #2e1f17;
    }
    input, button, select {
      font-family: inherit;
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
      border: 1px solid #d0bfae;
      margin: 0.3rem;
      font-size: 1rem;
    }
    button {
      background: #3e2f27;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #5c4031;
    }
    .container {
      max-width: 900px;
      margin: 2em auto;
      background: rgba(255,255,255,0.85);
      border-radius: 12px;
      padding: 2em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .event-card {
      border: 1px solid #d0bfae;
      border-radius: 10px;
      padding: 1em;
      margin-top: 1em;
      background: #fffdfb;
      text-align: left;
    }
    .event-card a {
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>DigitalTables</h1>

    <div id="auth-section">
      <h2>Connexion / Cr√©ation de compte</h2>
      <input type="email" id="email" placeholder="Votre email" />
      <input type="password" id="password" placeholder="Mot de passe" />
      <br>
      <button id="login-btn">Se connecter</button>
      <button id="signup-btn">Cr√©er un compte</button>
    </div>

    <div id="dashboard" style="display:none;">
      <h2>Vos √©v√©nements</h2>
      <div id="create-event">
        <input type="text" id="event-username" placeholder="Nom de l'√©v√©nement (ex: mariage-sophie-paul)" />
        <label><input type="checkbox" id="is-private" /> √âv√©nement priv√©</label>
        <input type="password" id="event-password" placeholder="Mot de passe (si priv√©)" />
        <br>
        <button id="upload-csv">Uploader CSV</button>
        <button id="create-sheet">Cr√©er une Google Sheet</button>
      </div>
      <div id="events-list"></div>
      <button id="logout-btn">Se d√©connecter</button>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';

    const authSection = document.getElementById('auth-section');
    const dashboard = document.getElementById('dashboard');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const eventsList = document.getElementById('events-list');

    const usernameInput = document.getElementById('event-username');
    const isPrivateCheckbox = document.getElementById('is-private');
    const eventPasswordInput = document.getElementById('event-password');
    const uploadCsvBtn = document.getElementById('upload-csv');
    const createSheetBtn = document.getElementById('create-sheet');

    async function checkSession() {
      const { data } = await supabase.auth.getSession();
      if (data.session) showDashboard();
    }

    async function showDashboard() {
      authSection.style.display = 'none';
      dashboard.style.display = 'block';
      loadEvents();
    }

    async function loadEvents() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data, error } = await supabase
        .from('events')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        return;
      }

      eventsList.innerHTML = '';
      data.forEach(e => {
        const card = document.createElement('div');
        card.className = 'event-card';
        card.innerHTML = `<strong>${e.username}</strong><br>
          ${e.is_private ? 'üîí Priv√©' : 'üåê Public'}
          ${e.created_at ? `<br><small>Cr√©√© le ${new Date(e.created_at).toLocaleString()}</small>` : ''}
        `;

        // Lien √©v√©nement
        const link = document.createElement("a");
        link.href = `${window.location.origin}/events/tables.html?event=${encodeURIComponent(e.username)}`;
        link.textContent = "‚û°Ô∏è Voir l‚Äô√©v√©nement";
        link.style.display = "inline-block";
        link.style.marginTop = "8px";
        link.target = "_blank";
        card.appendChild(link);

        // Lien Google Sheet (si disponible)
        if (e.google_sheet_url) {
          const sheetLink = document.createElement("a");
          sheetLink.href = e.google_sheet_url;
          sheetLink.target = "_blank";
          sheetLink.textContent = "üìÑ Ouvrir Google Sheet";
          sheetLink.style.display = "block";
          sheetLink.style.marginTop = "6px";
          sheetLink.style.color = "#2b4a2b";
          sheetLink.style.fontWeight = "600";
          sheetLink.style.textDecoration = "underline";
          card.appendChild(sheetLink);
        }

        eventsList.appendChild(card);
      });
    }

    signupBtn.addEventListener('click', async () => {
      const { error } = await supabase.auth.signUp({
        email: emailInput.value,
        password: passwordInput.value,
      });
      if (error) alert(error.message);
      else showDashboard();
    });

    loginBtn.addEventListener('click', async () => {
      const { error } = await supabase.auth.signInWithPassword({
        email: emailInput.value,
        password: passwordInput.value,
      });
      if (error) alert(error.message);
      else showDashboard();
    });

    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      dashboard.style.display = 'none';
      authSection.style.display = 'block';
    });

    // ---- UPLOAD CSV ----
    uploadCsvBtn.addEventListener('click', async () => {
      const username = usernameInput.value.trim();
      if (!username) return alert('Veuillez entrer un nom d‚Äô√©v√©nement.');

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert('Connectez-vous.');

      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.csv';
      fileInput.onchange = async () => {
        const file = fileInput.files[0];
        if (!file) return;
        const filePath = `guests_${username}.csv`;

        const { error: uploadError } = await supabase.storage
          .from('guests')
          .upload(filePath, file, { upsert: true });
        if (uploadError) return alert(uploadError.message);

        const { error: insertError } = await supabase.from('events').upsert({
          username,
          user_id: user.id,
          is_private: isPrivateCheckbox.checked,
          event_password: eventPasswordInput.value || null,
          csv_path: filePath,
          created_at: new Date().toISOString(),
        });
        if (insertError) return alert(insertError.message);
        alert('CSV upload√© avec succ√®s !');
        loadEvents();
      };
      fileInput.click();
    });

    // ---- CR√âER GOOGLE SHEET ----
    createSheetBtn.addEventListener('click', async () => {
      const username = usernameInput.value.trim();
      if (!username) return alert('Veuillez entrer un nom d‚Äô√©v√©nement.');

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert('Connectez-vous.');

      const isPrivate = isPrivateCheckbox.checked;
      const password = eventPasswordInput.value || null;

      const res = await fetch(`${supabase.supabaseUrl}/functions/v1/create-google-sheet`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${supabase.supabaseKey}`
        },
        body: JSON.stringify({
          userId: user.id,
          username,
          isPrivate,
          event_password: password
        })
      });

      const data = await res.json();
      if (!res.ok) {
        console.error(data);
        return alert('Erreur : ' + (data.error || 'Impossible de cr√©er la Google Sheet'));
      }

      await supabase.from('events').upsert({
        username,
        user_id: user.id,
        is_private: isPrivate,
        event_password: password,
        google_sheet_url: data.sheetUrl,
        created_at: new Date().toISOString(),
      });

      alert('Google Sheet cr√©√©e avec succ√®s !');
      loadEvents();
    });

    checkSession();
  </script>
</body>
</html>
