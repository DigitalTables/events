<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DigitalTables ‚Äì Gestion des tables invit√©s</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header>
  <div class="container">
    <div class="logo-title">
      <img src="images/Logo.jpg" alt="Logo DigitalTables" class="logo" />
      <h1>DigitalTables</h1>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h2>Attribuez facilement la table de vos invit√©s</h2>
    <p>Importez un CSV ou utilisez une Google Sheet. Public ou priv√©, en toute simplicit√©.</p>
  </div>
</section>

<div style="text-align:center; margin-top:1rem;">
  <button id="logout" style="display:none; max-width:300px;">Se d√©connecter</button>
</div>

<!-- AUTH -->
<div id="auth" class="card">
  <h3>Connexion / Inscription</h3>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Mot de passe" />
  <button id="signup">Cr√©er un compte</button>
  <button id="login">Se connecter</button>
</div>

<!-- CREATE EVENT -->
<div id="upload" class="card" style="display:none;">
  <h3>Cr√©er un √©v√©nement</h3>

  <label>Identifiant public (URL)</label>
  <input type="text" id="username" placeholder="ex : mariage-anne-2026" />
  <div id="usernameStatus" class="hint"></div>

  <div class="card soft">
    <strong>Visibilit√© de l‚Äô√©v√©nement</strong>
    <label>
      <input type="checkbox" id="privateCsv" />
      √âv√©nement priv√© (mot de passe requis)
    </label>
  </div>

  <div id="passwordDiv" style="display:none;">
    <input type="password" id="eventPassword" placeholder="Mot de passe de l‚Äô√©v√©nement" />
  </div>

  <div class="mode-selector">
    <label>
      <input type="radio" name="mode" id="modeCsv" checked />
      üìÑ Import CSV
    </label>
    <label>
      <input type="radio" name="mode" id="modeSheet" />
      üìä Google Sheet
    </label>
  </div>

  <h4 id="uploadTitle">Importer votre fichier CSV</h4>
  <input type="file" id="guests" accept=".csv" />

  <h4>Images par table (optionnel)</h4>
  <div id="tableImageRows"></div>
  <button id="addTableImageRow">Ajouter une table</button>

  <button id="createEventBtn">Cr√©er l‚Äô√©v√©nement</button>

  <div id="publicUrl" class="hint"></div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="container" style="display:none;">
  <h3 style="text-align:center;">Mes √©v√©nements</h3>
  <div id="eventsContainer" class="dashboard-grid"></div>
</div>

<footer>
  <div class="container">
    <p>¬© 2025 DigitalTables. Tous droits r√©serv√©s.</p>
  </div>
</footer>

<!-- ===================== SCRIPT ===================== -->
<script type="module">
import { supabase, SUPABASE_URL, getPrivateCsv } from './supabase.js';
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";

/* === DOM === */
const authDiv = document.getElementById("auth");
const uploadDiv = document.getElementById("upload");
const dashboardDiv = document.getElementById("dashboard");
const logoutBtn = document.getElementById("logout");

const privateCsvCheckbox = document.getElementById("privateCsv");
const passwordDiv = document.getElementById("passwordDiv");

privateCsvCheckbox.onchange = () => {
  passwordDiv.style.display = privateCsvCheckbox.checked ? "block" : "none";
};

/* === AUTH === */
supabase.auth.getSession().then(({ data }) => {
  data.session ? onLogin() : onLogout();
});

supabase.auth.onAuthStateChange((_e, s) => {
  s ? onLogin() : onLogout();
});

function onLogin() {
  authDiv.style.display = "none";
  uploadDiv.style.display = "block";
  logoutBtn.style.display = "inline-block";
  dashboardDiv.style.display = "block";
  loadUserUploads().then(enforceEventLimit);
}

function onLogout() {
  authDiv.style.display = "block";
  uploadDiv.style.display = "none";
  logoutBtn.style.display = "none";
  dashboardDiv.style.display = "none";
}

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
};

/* ‚ö†Ô∏è TOUT LE JS M√âTIER (cr√©ation event, CSV, sheets, dashboard, sync priv√©, delete)
   RESTE STRICTEMENT IDENTIQUE √Ä TON CODE ACTUEL
   ‚Üí tu peux le coller ici sans aucune modification */
</script>

</body>
</html>
