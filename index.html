<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DigitalTables â€“ Gestion des tables invitÃ©s</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header>
  <div class="container">
    <div class="logo-title">
      <img src="images/Logo.jpg" alt="Logo DigitalTables" class="logo" />
      <h1>DigitalTables</h1>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h2>Attribuez facilement la table de vos invitÃ©s</h2>
    <p>Import CSV ou Google Sheet â€¢ Ã‰vÃ©nement public ou privÃ©</p>
  </div>
</section>

<div style="text-align:center; margin-top:1rem;">
  <button id="logout" style="display:none; max-width:300px;">Se dÃ©connecter</button>
</div>

<!-- ================= AUTH ================= -->
<section id="auth">
  <div class="container" style="max-width:480px;">
    <h3 style="text-align:center;">Connexion / Inscription</h3>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Mot de passe" />
    <button id="signup">CrÃ©er un compte</button>
    <button id="login">Se connecter</button>
  </div>
</section>

<!-- ================= DASHBOARD ================= -->
<section id="dashboard" style="display:none;">
  <div class="container">
    <h3 style="text-align:center;">Mes Ã©vÃ©nements</h3>
    <div id="eventsContainer" class="dashboard-grid"></div>
  </div>
</section>

<!-- ================= CREATE / EDIT EVENT ================= -->
<section id="upload" style="display:none;">
  <div class="container" style="max-width:720px;">
    <h3 id="formTitle" style="text-align:center;">CrÃ©er / Modifier un Ã©vÃ©nement</h3>

    <label>Identifiant public (URL)</label>
    <input type="text" id="username" />
    <div id="usernameStatus" class="hint"></div>

    <label style="margin-top:1rem;">
      <input type="checkbox" id="privateCsv" />
      Ã‰vÃ©nement privÃ©
    </label>

    <div id="passwordDiv" style="display:none;">
      <input type="password" id="eventPassword" placeholder="Mot de passe" />
    </div>

    <hr>

    <h4>Importer / remplacer le CSV</h4>
    <input type="file" id="guests" accept=".csv" />

    <hr>

    <h4>Images par table (optionnel)</h4>
    <div id="tableImageRows"></div>
    <button id="addTableImageRow">â• Ajouter une table</button>

    <hr>

    <button id="createEventBtn">ğŸ’¾ Enregistrer</button>
  </div>
</section>

<footer>
  <div class="container">
    <p>Â© 2025 DigitalTables</p>
  </div>
</footer>

<script type="module">
import { supabase, SUPABASE_URL } from './supabase.js';
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";

let editingEventId = null;

const authDiv = document.getElementById("auth");
const uploadDiv = document.getElementById("upload");
const dashboardDiv = document.getElementById("dashboard");
const eventsContainer = document.getElementById("eventsContainer");
const logoutBtn = document.getElementById("logout");

const usernameInput = document.getElementById("username");
const privateCsvCheckbox = document.getElementById("privateCsv");
const passwordDiv = document.getElementById("passwordDiv");
const eventPasswordInput = document.getElementById("eventPassword");
const csvInput = document.getElementById("guests");
const createEventBtn = document.getElementById("createEventBtn");

privateCsvCheckbox.onchange = () => {
  passwordDiv.style.display = privateCsvCheckbox.checked ? "block" : "none";
};

supabase.auth.onAuthStateChange((_e, s) => {
  if (s) {
    authDiv.style.display = "none";
    dashboardDiv.style.display = "block";
    uploadDiv.style.display = "block";
    logoutBtn.style.display = "inline-block";
    loadUserUploads();
  }
});

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

async function loadUserUploads() {
  eventsContainer.innerHTML = "";
  const { data: userData } = await supabase.auth.getUser();

  const { data: events } = await supabase
    .from("events")
    .select("*")
    .eq("user_id", userData.user.id)
    .eq("deleted", false);

  if (!events?.length) {
    eventsContainer.textContent = "Aucun Ã©vÃ©nement.";
    return;
  }

  for (const e of events) {
    const card = document.createElement("div");
    card.className = "dashboard-card";

    card.innerHTML = `
      <h4>${e.username}</h4>
      <a href="/events/tables.html?event=${e.username}" target="_blank">ğŸ”— Lien public</a>
      ${e.google_sheet_url ? `<a href="${e.google_sheet_url}" target="_blank">ğŸ“Š Google Sheet</a>` : ""}
    `;

    if (e.google_sheet_url && e.is_private) {
      const syncBtn = document.createElement("button");
      syncBtn.textContent = "ğŸ”„ Sync Google Sheet privÃ©";
      card.appendChild(syncBtn);
    }

    const editBtn = document.createElement("button");
    editBtn.textContent = "âœï¸ Modifier lâ€™Ã©vÃ©nement";
    editBtn.onclick = () => loadEventForEdit(e);
    card.appendChild(editBtn);

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "ğŸ”¥ Supprimer dÃ©finitivement";
    deleteBtn.className = "danger";
    deleteBtn.onclick = async () => {
      if (!confirm("Supprimer dÃ©finitivement ?")) return;
      await supabase.from("events").update({ deleted: true }).eq("id", e.id);
      loadUserUploads();
    };

    card.appendChild(deleteBtn);
    eventsContainer.appendChild(card);
  }
}

function loadEventForEdit(e) {
  editingEventId = e.id;
  usernameInput.value = e.username;
  usernameInput.disabled = true;
  privateCsvCheckbox.checked = e.is_private;
  eventPasswordInput.value = e.event_password || "";
  passwordDiv.style.display = e.is_private ? "block" : "none";
  createEventBtn.textContent = "ğŸ’¾ Mettre Ã  jour";
  window.scrollTo({ top: uploadDiv.offsetTop, behavior: "smooth" });
}

createEventBtn.onclick = async () => {
  const { data: userData } = await supabase.auth.getUser();
  const username = usernameInput.value.trim();

  if (csvInput.files[0]) {
    const text = await csvInput.files[0].text();
    await supabase.storage
      .from("guests")
      .upload(`guests_${username}.csv`, new Blob([text]), { upsert: true });
  }

  const payload = {
    is_private: privateCsvCheckbox.checked,
    event_password: privateCsvCheckbox.checked ? eventPasswordInput.value : null
  };

  if (editingEventId) {
    await supabase.from("events").update(payload).eq("id", editingEventId);
  }

  alert("âœ… Ã‰vÃ©nement enregistrÃ©");
  editingEventId = null;
  usernameInput.disabled = false;
  createEventBtn.textContent = "CrÃ©er lâ€™Ã©vÃ©nement";
  loadUserUploads();
};
</script>

</body>
</html>
