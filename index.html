<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DigitalTables ‚Äì Gestion des tables invit√©s</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header>
  <div class="container">
    <div class="logo-title">
      <img src="images/Logo.jpg" alt="Logo DigitalTables" class="logo" />
      <h1>DigitalTables</h1>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h2>Attribuez facilement la table de vos invit√©s</h2>
    <p>Import CSV ou Google Sheet ‚Ä¢ √âv√©nement public ou priv√©</p>
  </div>
</section>

<div style="text-align:center; margin-top:1rem;">
  <button id="logout" style="display:none; max-width:300px;">Se d√©connecter</button>
</div>

<!-- ================= AUTH ================= -->
<section id="auth">
  <div class="container" style="max-width:480px;">
    <h3 style="text-align:center;">Connexion / Inscription</h3>

    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Mot de passe" />

    <button id="signup">Cr√©er un compte</button>
    <button id="login">Se connecter</button>
  </div>
</section>


<!-- ================= DASHBOARD ================= -->
<section id="dashboard" style="display:none;">
  <div class="container">
    <h3 style="text-align:center;">Mes √©v√©nements</h3>
    <div id="eventsContainer" class="dashboard-grid"></div>
  </div>
</section>



 <!-- ================= CREATE EVENT ================= -->
<section id="upload" style="display:none;">
  <div class="container" style="max-width:720px;">

    <h3 style="text-align:center;">Cr√©er un √©v√©nement</h3>

    <label>Identifiant public (URL)</label>
    <input type="text" id="username" placeholder="ex : mariage-anne-2026" />
    <div id="usernameStatus" class="hint"></div>

    <hr style="margin:2rem 0;">

    <strong>Visibilit√© de l‚Äô√©v√©nement</strong>
    <label style="display:block; margin-top:0.5rem;">
      <input type="checkbox" id="privateCsv" />
      √âv√©nement priv√© (acc√®s par mot de passe)
    </label>

    <div id="passwordDiv" style="display:none; margin-top:0.75rem;">
      <input type="password" id="eventPassword" placeholder="Mot de passe de l‚Äô√©v√©nement" />
    </div>

    <hr style="margin:2rem 0;">

    <strong>Source des invit√©s</strong>

    <div class="mode-selector">
      <label>
        <input type="radio" name="mode" id="modeCsv" checked />
        üìÑ Import CSV
      </label>
      <label>
        <input type="radio" name="mode" id="modeSheet" />
        üìä Google Sheet
      </label>
    </div>

    <h4 id="uploadTitle">Importer votre fichier CSV</h4>
    <input type="file" id="guests" accept=".csv" />

    <hr style="margin:2rem 0;">

    <!-- ===== IMAGES OPTIONNELLES ===== -->
    <h4>Images par table (optionnel)</h4>
    <p style="font-size:0.9rem; color:#6b5a4a;">
      Vous pouvez associer une image √† certaines tables (facultatif).
    </p>

    <div id="tableImageRows"></div>

    <button
      id="addTableImageRow"
      style="max-width:260px; margin-bottom:2rem;"
    >
      ‚ûï Ajouter une table
    </button>

    <!-- ===== ACTION PRINCIPALE ===== -->
    <hr style="margin:2.5rem 0;">

    <div style="text-align:center;">
      <p style="font-weight:600; margin-bottom:0.5rem;">
        Une fois tout pr√™t :
      </p>

      <button
        id="createEventBtn"
        style="max-width:360px; font-size:1.1rem;"
      >
        ‚úÖ Cr√©er l‚Äô√©v√©nement
      </button>
    </div>

    <div id="publicUrl" class="hint" style="margin-top:1rem; text-align:center;"></div>

  </div>

<footer>
  <div class="container">
    <p>¬© 2025 DigitalTables. Tous droits r√©serv√©s.</p>
  </div>
</footer>
  
</section>

  
<!-- ================= SCRIPT ================= -->
<script type="module">
import { supabase, SUPABASE_URL, getPrivateCsv } from './supabase.js';
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";

/* ================= DOM ================= */
const authDiv = document.getElementById("auth");
const uploadDiv = document.getElementById("upload");
const dashboardDiv = document.getElementById("dashboard");
const logoutBtn = document.getElementById("logout");

const email = document.getElementById("email");
const password = document.getElementById("password");
const signup = document.getElementById("signup");
const login = document.getElementById("login");

const createEventBtn = document.getElementById("createEventBtn");
const csvInput = document.getElementById("guests");
const usernameInput = document.getElementById("username");
const usernameStatus = document.getElementById("usernameStatus");
const privateCsvCheckbox = document.getElementById("privateCsv");
const passwordDiv = document.getElementById("passwordDiv");
const eventPasswordInput = document.getElementById("eventPassword");
const publicUrlDiv = document.getElementById("publicUrl");
const tableImageRows = document.getElementById("tableImageRows");
const addTableImageRowBtn = document.getElementById("addTableImageRow");
const modeCsv = document.getElementById("modeCsv");
const modeSheet = document.getElementById("modeSheet");
const uploadTitle = document.getElementById("uploadTitle");

/* ================= UI ================= */
privateCsvCheckbox.onchange = () => {
  passwordDiv.style.display = privateCsvCheckbox.checked ? "block" : "none";
};

function updateModeUI() {
  if (modeCsv.checked) {
    uploadTitle.textContent = "Importer votre fichier CSV";
    csvInput.style.display = "block";
  } else {
    uploadTitle.textContent = "Les invit√©s seront g√©r√©s via Google Sheet";
    csvInput.style.display = "none";
  }
}
modeCsv.onchange = updateModeUI;
modeSheet.onchange = updateModeUI;
updateModeUI();

/* ================= AUTH ================= */
supabase.auth.getSession().then(({ data }) => {
  data.session ? onLogin() : onLogout();
});
supabase.auth.onAuthStateChange((_e, s) => {
  s ? onLogin() : onLogout();
});

function onLogin() {
  authDiv.style.display = "none";
  uploadDiv.style.display = "block";
  logoutBtn.style.display = "inline-block";
  dashboardDiv.style.display = "block";
  loadUserUploads().then(enforceEventLimit);
}

function onLogout() {
  authDiv.style.display = "block";
  uploadDiv.style.display = "none";
  logoutBtn.style.display = "none";
  dashboardDiv.style.display = "none";
}

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
};

/* ================= SIGNUP / LOGIN ================= */
signup.onclick = async () => {
  const { error } = await supabase.auth.signUp({
    email: email.value,
    password: password.value
  });
  if (error) return alert(error.message);
  await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
};

login.onclick = async () => {
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) alert(error.message);
};

/* ================= USERNAME CHECK ================= */
async function checkPublicJsonExists(username) {
  const { data } = await supabase.storage
    .from("public-guests")
    .list("", { search: `guests_${username}.json` });
  return data?.some(f => f.name === `guests_${username}.json`);
}

usernameInput.onblur = async () => {
  const u = usernameInput.value.trim();
  if (!u) return usernameStatus.textContent = "";
  const exists = await checkPublicJsonExists(u);
  usernameStatus.textContent = exists ? "‚ùå Identifiant d√©j√† utilis√©" : "‚úî Disponible";
  usernameStatus.style.color = exists ? "red" : "green";
};



/* ================= DASHBOARD ================= */
async function loadUserUploads() {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return;

  const { data: events } = await supabase
    .from("events")
    .select("*")
    .eq("user_id", user.id)
    .eq("deleted", false);

  const container = document.getElementById("eventsContainer");
  container.innerHTML = "";

  // ‚úÖ Masquer la cr√©ation d'√©v√©nement si au moins un existe
  const uploadDiv = document.getElementById("upload");
  if (events?.length > 0) {
    uploadDiv.style.display = "none";
  } else {
    uploadDiv.style.display = "block";
  }

  if (!events?.length) {
    container.textContent = "Aucun √©v√©nement pour l‚Äôinstant.";
    return;
  }

  for (const e of events) {
    const card = document.createElement("div");

    card.innerHTML = `
      <h4>${e.username}</h4>
      <a href="/events/tables.html?event=${e.username}" target="_blank">Lien √©v√©nement</a>
      ${e.google_sheet_url ? `<a href="${e.google_sheet_url}" target="_blank">üìä Google Sheet</a>` : ""}


      
      <button class="danger">üî• Supprimer d√©finitivement</button>
    `;

    /* SYNC PRIVATE SHEET */
if (e.google_sheet_url && e.is_private) {
  const syncOneBtn = document.createElement("button");
  syncOneBtn.textContent = "Sync Google sheet priv√©e";

  syncOneBtn.onclick = async () => {
    const session = await supabase.auth.getSession();
    const accessToken = session.data.session?.access_token;
    if (!accessToken) return alert("‚ùå Connecte-toi.");

    syncOneBtn.textContent = "Sync...";
    syncOneBtn.disabled = true;

    try {const res = await fetch(
  `${SUPABASE_URL}/functions/v1/sync-privatesheet-csv`,
  {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${accessToken}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      event_id: e.id,
      username: e.username,
      google_sheet_url: e.google_sheet_url,
      password: e.event_password
    })
  }
);
  

      let data = {};
      try {
        data = JSON.parse(await res.text());
      } catch {}

      if (!res.ok) throw new Error(data.error || "Unknown sync error");

      alert("‚úÖ Google Sheet synchronis√©e !");
      await loadUserUploads().then(enforceEventLimit);

    } catch (err) {
      alert("‚ùå Sync error : " + err.message);
    } finally {
      syncOneBtn.textContent = "Sync Google sheet priv√©e";
      syncOneBtn.disabled = false;
    }
  };

  card.appendChild(syncOneBtn);

  if (e.updated_at) {
    const syncInfo = document.createElement("div");
    syncInfo.textContent =
      "üîÑ Derni√®re sync : " + formatDateWithTimeZone(e.updated_at);
    syncInfo.style.fontSize = "0.85rem";
    card.appendChild(syncInfo);
  }
}


    card.querySelector("button").onclick = async () => {
      if (!confirm("Supprimer d√©finitivement ?")) return;
      await supabase.from("events").update({ deleted: true }).eq("id", e.id);
      loadUserUploads();
    };

    container.appendChild(card);
  }
}


 
/* ================= TABLE IMAGES ================= */
function addTableImageRow() {
  const div = document.createElement("div");
  div.style.marginBottom = "0.5rem";
  div.innerHTML = `
    <input type="text" placeholder="Nom de la table" />
    <input type="file" accept="image/*" />
    <button type="button">‚ùå</button>
  `;
  div.querySelector("button").onclick = () => div.remove();
  tableImageRows.appendChild(div);
}
addTableImageRowBtn.onclick = addTableImageRow;

/* ================= CREATE EVENT ================= */
createEventBtn.onclick = async () => {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  alert("Click create Event !");
  if (!user) return alert("Connecte-toi");

  const username = usernameInput.value.trim();
  if (!username) return alert("Identifiant requis");

  const isPrivate = privateCsvCheckbox.checked;
  const passwordEvent = eventPasswordInput.value.trim();
  if (isPrivate && !passwordEvent) return alert("Mot de passe requis");

  const mode = modeCsv.checked ? "csv" : "sheet";

  try {
  
    createEventBtn.disabled = true;
    createEventBtn.textContent = "Cr√©ation‚Ä¶";

    let signedUrl = null;

    if (mode === "csv") {
      const file = csvInput.files[0];
      if (!file) throw new Error("CSV manquant");

      const text = await file.text();
      const parsed = Papa.parse(text, { header: true }).data;

      await supabase.storage
        .from("guests")
        .upload(`guests_${username}.csv`, new Blob([text]), { upsert: true });

      if (!isPrivate) {
        await supabase.storage
          .from("public-guests")
          .upload(
            `guests_${username}.json`,
            new Blob([JSON.stringify(parsed)]),
            { upsert: true }
          );
        signedUrl = `${SUPABASE_URL}/storage/v1/object/public/public-guests/guests_${username}.json`;
      }
    }

   const { data, error } = await supabase
  .from("events")
  .upsert(
    {
      username,
      is_private: isPrivate,
      event_password: isPrivate ? passwordEvent : null,
      signed_url: signedUrl,
      user_id: user.id,
      uploaded_at: new Date().toISOString()
    },
    { onConflict: "username" }
  );

if (error) throw error;


    alert("‚úÖ √âv√©nement cr√©√© !");
    loadUserUploads().then(enforceEventLimit);

  } catch (e) {
    alert(e.message);
  } finally {
    createEventBtn.disabled = false;
    createEventBtn.textContent = "Cr√©er l‚Äô√©v√©nement";
  }
};


/* ================= LIMIT ================= */
async function enforceEventLimit() {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  const { data: events } = await supabase
    .from("events")
    .select("id")
    .eq("user_id", user.id)
    .eq("deleted", false);

  createEventBtn.disabled = events.length >= 1;
}

  /* Format pour la date d'update*/
  function formatDateWithTimeZone(dateString) {
  return new Date(dateString).toLocaleString(undefined, {
    timeZoneName: "short"
  });
}

</script>

</body>
</html>
