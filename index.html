<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DigitalTables ‚Äì Gestion des tables invit√©s</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <div class="container">
    <div class="logo-title">
      <img src="images/Logo.jpg" alt="Logo DigitalTables" class="logo" />
      <h1>DigitalTables</h1>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h2>Attribuez facilement la table de vos invit√©s</h2>
    <p>Un outil simple et rapide qui apporte une touche unique √† votre √©v√©nement.</p> 
  </div>
</section>

<div style="text-align:center; margin-top:1rem;">
  <button id="logout" style="display:none;">Se d√©connecter</button>
</div>

<!-- Section Auth -->
<div id="auth" style="text-align:center; margin-top:2rem;">
  <h3>Connexion / Inscription</h3>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Mot de passe" />
  <button id="signup">Cr√©er un compte</button>
  <button id="login">Se connecter</button>
</div>

<!-- Section Upload -->
<div id="upload" style="display:none; text-align:center; margin-top:2rem;">
  <div style="margin-bottom:1rem;">
    <label for="username" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Choisissez un identifiant public (visible dans l‚ÄôURL) :
    </label>
    <input type="text" id="username" placeholder="ex: johanna-martin-2026" />
    <div id="usernameStatus" style="margin-top:0.25rem; font-size:0.9rem;"></div>
  </div>

  <div style="margin-bottom:1rem;">
    <label>
      <input type="checkbox" id="privateCsv" /> CSV priv√© (acc√®s via mot de passe)
    </label>
  </div>

  <div id="passwordDiv" style="display:none; margin-bottom:1rem;">
    <label for="eventPassword" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Mot de passe de l‚Äô√©v√©nement :
    </label>
    <input type="password" id="eventPassword" placeholder="Mot de passe de l‚Äô√©v√©nement" />
  </div>

  <h3>Uploader ton CSV et tes images</h3>
  <input type="file" id="guests" accept=".csv" /><br><br>
  <input type="file" id="images" accept="image/*" multiple /><br><br>
  <button id="send">Envoyer</button>

  <div id="publicUrl" style="margin-top:1rem; font-size:0.9rem; word-break:break-all;"></div>
</div>

<!-- Dashboard utilisateur -->
<div id="dashboard" style="display:none; margin-top:2rem;">
  <h3>Mon Tableau de Bord</h3>
  <div id="dashboardContent"></div>
</div>

<footer>
  <div class="container">
    <p>¬© 2025 DigitalTables. Tous droits r√©serv√©s.</p>
  </div>
</footer>

<script type="module">
import { supabase, getPrivateCsv } from './supabase.js';
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";

const authDiv = document.getElementById("auth");
const uploadDiv = document.getElementById("upload");
const dashboardDiv = document.getElementById("dashboard");
const dashboardContent = document.getElementById("dashboardContent");
const logoutBtn = document.getElementById("logout");
const email = document.getElementById("email");
const password = document.getElementById("password");
const signup = document.getElementById("signup");
const login = document.getElementById("login");
const sendBtn = document.getElementById("send");
const csvInput = document.getElementById("guests");
const imagesInput = document.getElementById("images");
const usernameInput = document.getElementById("username");
const usernameStatus = document.getElementById("usernameStatus");
const privateCsvCheckbox = document.getElementById("privateCsv");
const passwordDiv = document.getElementById("passwordDiv");
const eventPasswordInput = document.getElementById("eventPassword");
const publicUrlDiv = document.getElementById("publicUrl");

// Toggle mot de passe si priv√©
privateCsvCheckbox.addEventListener("change", () => {
  passwordDiv.style.display = privateCsvCheckbox.checked ? "block" : "none";
});

// Connexion / d√©connexion
function onLogin() {
  authDiv.style.display = "none";
  uploadDiv.style.display = "block";
  logoutBtn.style.display = "inline-block";
  loadDashboard();
}
function onLogout() {
  authDiv.style.display = "block";
  uploadDiv.style.display = "none";
  dashboardDiv.style.display = "none";
  logoutBtn.style.display = "none";
  publicUrlDiv.textContent = "";
}

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  onLogout();
};

// V√©rifie si d√©j√† connect√©
supabase.auth.getSession().then(({ data }) => {
  if (data.session) onLogin();
  else onLogout();
});
supabase.auth.onAuthStateChange((_event, session) => {
  if (session) onLogin();
  else onLogout();
});

// Authentification simplifi√©e
signup.onclick = async () => {
  const { data, error } = await supabase.auth.signUp({ email: email.value, password: password.value });
  if (error) return alert("Erreur : " + error.message);
  const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
  if (loginError) return alert("Erreur login : " + loginError.message);
  onLogin();
  alert("‚úÖ Compte cr√©√© et connect√© !");
};
login.onclick = async () => {
  const { error } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
  if (error) alert("Erreur : " + error.message);
  else onLogin();
};

// V√©rifie si un JSON public existe d√©j√†
async function checkPublicJsonExists(username) {
  const { data, error } = await supabase.storage.from("public-guests").list("", { search: `guests_${username}.json` });
  if (error) return false;
  return data.some(f => f.name === `guests_${username}.json`);
}

usernameInput.addEventListener("blur", async () => {
  const username = usernameInput.value.trim();
  if (!username) { usernameStatus.textContent = ""; return; }
  const exists = await checkPublicJsonExists(username);
  usernameStatus.textContent = exists ? "‚ùå Pseudo d√©j√† utilis√©" : "‚úÖ Disponible";
  usernameStatus.style.color = exists ? "red" : "green";
});

// Upload CSV et images
sendBtn.onclick = async () => {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return alert("‚ùå Tu dois √™tre connect√©.");

  const username = usernameInput.value.trim();
  if (!username) return alert("‚ùå Choisis un identifiant public.");

  const isPrivate = privateCsvCheckbox.checked;
  const eventPassword = eventPasswordInput.value.trim();
  if (isPrivate && !eventPassword) return alert("‚ùå D√©finis un mot de passe pour l‚Äô√©v√©nement priv√©.");

  const csvFile = csvInput.files[0];
  if (!csvFile) return alert("‚ùå Choisis un fichier CSV.");

  const text = await csvFile.text();
  const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
  const rows = parsed.data;

  // Upload CSV
  const csvPath = `guests_${username}.csv`;
  const { error: csvUpErr } = await supabase.storage.from("guests").upload(csvPath, new Blob([text], { type: "text/csv" }), { upsert: true });
  if (csvUpErr) return alert("Erreur upload CSV: " + csvUpErr.message);

  let publicOrSignedUrl = null;
  if (!isPrivate) {
    const publicJsonName = `guests_${username}.json`;
    const jsonBlob = new Blob([JSON.stringify(rows, null, 2)], { type: "application/json" });
    const { error: jsonUpErr } = await supabase.storage.from("public-guests").upload(publicJsonName, jsonBlob, { upsert: true });
    if (jsonUpErr) return alert("Erreur upload JSON: " + jsonUpErr.message);
    publicOrSignedUrl = `${supabase.supabaseUrl}/storage/v1/object/public/public-guests/${publicJsonName}`;
  } else {
    try {
      const signedUrl = await getPrivateCsv(username, eventPassword, user.id);
      publicOrSignedUrl = signedUrl;
    } catch(e) {
      return alert("Erreur g√©n√©ration URL sign√©e pour le CSV priv√©: " + e.message);
    }
  }

  // Enregistrer l‚Äô√©v√©nement
  const { error: upsertErr } = await supabase.from("events").upsert({
    username,
    event_password: isPrivate ? eventPassword : null,
    signed_url: publicOrSignedUrl,
    is_private: isPrivate,
    user_id: user.id,
    uploaded_at: new Date().toISOString()
  }, { onConflict: "username" });
  if (upsertErr) return alert("Erreur enregistrement √©v√©nement: " + upsertErr.message);

  // Upload images
  const imgs = imagesInput.files;
  for (const img of imgs) {
    const { error: imgErr } = await supabase.storage.from("images").upload(`${username}/${img.name}`, img, { upsert: true });
    if (imgErr) return alert("Erreur upload image: " + imgErr.message);
  }

  // Afficher le lien
  const eventUrl = `${window.location.origin}/events/tables.html?event=${encodeURIComponent(username)}`;
  publicUrlDiv.innerHTML = isPrivate
    ? `üîí √âv√©nement priv√© cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</a></strong>`
    : `üåç √âv√©nement public cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</a></strong> <br><code>${publicOrSignedUrl}</code>`;

  alert("‚úÖ Upload termin√© !");
  loadDashboard(); // actualiser le dashboard
};

// ---------------------------
// DASHBOARD UTILISATEUR
// ---------------------------
async function loadDashboard() {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return;

  const { data: events, error } = await supabase
    .from("events")
    .select("*")
    .eq("user_id", user.id)
    .order("uploaded_at", { ascending: false });

  if (error) return dashboardContent.textContent = "Erreur chargement tableau de bord : " + error.message;
  if (!events || events.length === 0) {
    dashboardContent.textContent = "Vous n'avez encore upload√© aucun √©v√©nement.";
    return;
  }

  dashboardDiv.style.display = "block";
  dashboardContent.innerHTML = "";

  for (const ev of events) {
    const evDiv = document.createElement("div");
    evDiv.style.border = "1px solid #d0bfae";
    evDiv.style.padding = "1rem";
    evDiv.style.borderRadius = "8px";
    evDiv.style.marginBottom = "1rem";

    const uploadedAt = ev.uploaded_at ? new Date(ev.uploaded_at).toLocaleString() : "‚Äî";

    // CSV
    let csvLink = "‚Äî";
    if (ev.is_private && ev.username) {
      try {
        const signedUrl = await getPrivateCsv(ev.username, ev.event_password, user.id);
        csvLink = `<a href="${signedUrl}" target="_blank">T√©l√©charger CSV priv√©</a>`;
      } catch(e) {
        csvLink = "Erreur r√©cup√©ration CSV priv√©";
      }
    } else if (!ev.is_private && ev.username) {
      csvLink = `<a href="${supabase.supabaseUrl}/storage/v1/object/public/public-guests/guests_${ev.username}.json" target="_blank">T√©l√©charger JSON public</a>`;
    }

    // Images
    let imageLinks = "‚Äî";
    if (ev.username) {
      try {
        const { data: imagesList } = await supabase.storage.from("images").list(ev.username);
        if (imagesList.length > 0) {
          imageLinks = imagesList.map(img => {
            const url = supabase.storage.from("images").getPublicUrl(`${ev.username}/${img.name}`).data.publicUrl;
            return `<a href="${url}" target="_blank">${img.name}</a>`;
          }).join("<br>");
        }
      } catch(e) {
        imageLinks = "Erreur r√©cup√©ration images";
      }
    }

    const publicLink = `${window.location.origin}/events/tables.html?event=${encodeURIComponent(ev.username)}`;

    evDiv.innerHTML = `
      <strong>Pseudo public :</strong> ${ev.username || "‚Äî"}<br>
      <strong>Nom affich√© :</strong> ${ev.public_pseudo || "‚Äî"}<br>
      <strong>Date/heure upload :</strong> ${uploadedAt}<br>
      <strong>CSV :</strong> ${csvLink}<br>
      <strong>Images :</strong> ${imageLinks}<br>
      <strong>Lien de l'√©v√©nement :</strong> <a href="${publicLink}" target="_blank">${publicLink}</a>
    `;
    dashboardContent.appendChild(evDiv);
  }
}

</script>

</body>
</html>
