<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DigitalTables ‚Äì Gestion des tables invit√©s</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <div class="container">
    <div class="logo-title">
      <img src="images/Logo.jpg" alt="Logo DigitalTables" class="logo" />
      <h1>DigitalTables</h1>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h2>Attribuez facilement la table de vos invit√©s</h2>
    <p>Un outil simple et rapide qui apporte une touche unique √† votre √©v√©nement.</p> 
  </div>
</section>

<div style="text-align:center; margin-top:1rem;">
  <button id="logout" style="display:none;">Se d√©connecter</button>
</div>

<!-- Section Auth -->
<div id="auth" style="text-align:center; margin-top:2rem;">
  <h3>Connexion / Inscription</h3>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Mot de passe" />
  <button id="signup">Cr√©er un compte</button>
  <button id="login">Se connecter</button>
</div>

<!-- Section Upload -->
<div id="upload" style="display:none; text-align:center; margin-top:2rem;">
  <div style="margin-bottom:1rem;">
    <label for="username" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Choisissez un identifiant public (visible dans l‚ÄôURL) :
    </label>
    <input type="text" id="username" placeholder="ex: johanna-martin-2026" />
    <div id="usernameStatus" style="margin-top:0.25rem; font-size:0.9rem;"></div>
  </div>

  <div style="margin-bottom:1rem;">
    <label>
      <input type="checkbox" id="privateCsv" /> CSV priv√© (acc√®s via mot de passe)
    </label>
  </div>

  <div id="passwordDiv" style="display:none; margin-bottom:1rem;">
    <label for="eventPassword" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Mot de passe de l‚Äô√©v√©nement :
    </label>
    <input type="password" id="eventPassword" placeholder="Mot de passe de l‚Äô√©v√©nement" />
  </div>

  <h3>Uploader ton CSV et tes images</h3>
  <input type="file" id="guests" accept=".csv" /><br><br>

  <!-- Upload Images avec table associ√©e -->
  <div id="imagesUpload" style="margin-top:1rem;">
    <h4>Images des tables</h4>
    <div id="imageInputsContainer"></div>
    <button type="button" id="addImageBtn">Ajouter une image</button>
  </div><br>

  <button id="send">Envoyer</button>
  <div id="publicUrl" style="margin-top:1rem; font-size:0.9rem; word-break:break-all;"></div>
</div>

<footer>
  <div class="container">
    <p>¬© 2025 DigitalTables. Tous droits r√©serv√©s.</p>
  </div>
</footer>

<script type="module">
import { supabase, getPrivateCsv, getPrivateImages, checkPublicJsonExists } from './supabase.js';
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";

const authDiv = document.getElementById("auth");
const uploadDiv = document.getElementById("upload");
const logoutBtn = document.getElementById("logout");
const email = document.getElementById("email");
const password = document.getElementById("password");
const signup = document.getElementById("signup");
const login = document.getElementById("login");
const sendBtn = document.getElementById("send");
const csvInput = document.getElementById("guests");
const usernameInput = document.getElementById("username");
const usernameStatus = document.getElementById("usernameStatus");
const privateCsvCheckbox = document.getElementById("privateCsv");
const passwordDiv = document.getElementById("passwordDiv");
const eventPasswordInput = document.getElementById("eventPassword");
const publicUrlDiv = document.getElementById("publicUrl");

const imagesContainer = document.getElementById("imageInputsContainer");
const addImageBtn = document.getElementById("addImageBtn");

// Toggle mot de passe si priv√©
privateCsvCheckbox.addEventListener("change", () => {
  passwordDiv.style.display = privateCsvCheckbox.checked ? "block" : "none";
});

// Connexion / d√©connexion
function onLogin() {
  authDiv.style.display = "none";
  uploadDiv.style.display = "block";
  logoutBtn.style.display = "inline-block";
  loadUserUploads();
}
function onLogout() {
  authDiv.style.display = "block";
  uploadDiv.style.display = "none";
  logoutBtn.style.display = "none";
  publicUrlDiv.textContent = "";
}

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  onLogout();
};

// V√©rifie si d√©j√† connect√©
supabase.auth.getSession().then(({ data }) => {
  if (data.session) onLogin();
  else onLogout();
});
supabase.auth.onAuthStateChange((_event, session) => {
  if (session) onLogin();
  else onLogout();
});

// Authentification simplifi√©e sans mail de confirmation
signup.onclick = async () => {
  const { data, error } = await supabase.auth.signUp({ email: email.value, password: password.value });
  if (error) return alert("Erreur : " + error.message);
  const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
  if (loginError) return alert("Erreur login : " + loginError.message);
  onLogin();
  alert("‚úÖ Compte cr√©√© et connect√© !");
};
login.onclick = async () => {
  const { error } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
  if (error) alert("Erreur : " + error.message);
  else onLogin();
};

// V√©rifie si un pseudo existe
usernameInput.addEventListener("blur", async () => {
  const username = usernameInput.value.trim();
  if (!username) { usernameStatus.textContent = ""; return; }
  const exists = await checkPublicJsonExists(username);
  usernameStatus.textContent = exists ? "‚ùå Pseudo d√©j√† utilis√©" : "‚úÖ Disponible";
  usernameStatus.style.color = exists ? "red" : "green";
});

// Gestion images upload
function addImageInput() {
  const div = document.createElement("div");
  div.style.marginBottom = "0.5rem";

  const imgInput = document.createElement("input");
  imgInput.type = "file";
  imgInput.accept = "image/*";
  imgInput.style.marginRight = "0.5rem";

  const tableInput = document.createElement("input");
  tableInput.type = "text";
  tableInput.placeholder = "Nom de la table";
  
  div.appendChild(imgInput);
  div.appendChild(tableInput);
  imagesContainer.appendChild(div);
}

addImageBtn.addEventListener("click", addImageInput);
addImageInput();

// Upload CSV et images
sendBtn.onclick = async () => {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return alert("‚ùå Tu dois √™tre connect√©.");

  const username = usernameInput.value.trim();
  if (!username) return alert("‚ùå Choisis un identifiant public.");
  const isPrivate = privateCsvCheckbox.checked;
  const eventPassword = eventPasswordInput.value.trim();
  if (isPrivate && !eventPassword) return alert("‚ùå D√©finis un mot de passe pour l‚Äô√©v√©nement priv√©.");

  const csvFile = csvInput.files[0];
  if (!csvFile) return alert("‚ùå Choisis un fichier CSV.");

  const text = await csvFile.text();
  const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
  const rows = parsed.data;

  // Upload CSV
  const csvPath = `guests_${username}.csv`;
  const { error: csvUpErr } = await supabase.storage.from("guests").upload(csvPath, new Blob([text], { type: "text/csv" }), { upsert: true });
  if (csvUpErr) return alert("Erreur upload CSV: " + csvUpErr.message);

  let publicOrSignedUrl = null;
  if (!isPrivate) {
    publicOrSignedUrl = `${supabase.supabaseUrl}/storage/v1/object/public/guests/guests_${username}.csv`;
  } else {
    try {
      const signedUrl = await getPrivateCsv(username, eventPassword, user.id);
      publicOrSignedUrl = signedUrl;
    } catch(e) {
      return alert("Erreur g√©n√©ration URL sign√©e pour le CSV priv√©: " + e.message);
    }
  }

  // Enregistrer l‚Äô√©v√©nement
  const { error: upsertErr } = await supabase.from("events").upsert({
    username,
    event_password: isPrivate ? eventPassword : null,
    signed_url: publicOrSignedUrl,
    is_private: isPrivate,
    user_id: user.id,
    uploaded_at: new Date().toISOString()
  }, { onConflict: "username" });
  if (upsertErr) return alert("Erreur enregistrement √©v√©nement: " + upsertErr.message);

  // Upload images
  const imageDivs = imagesContainer.querySelectorAll("div");
  for (const div of imageDivs) {
    const imgFile = div.querySelector("input[type='file']").files[0];
    const tableName = div.querySelector("input[type='text']").value.trim();
    if (!imgFile || !tableName) continue;

    const imgPath = `${username}/tables/${tableName}_${imgFile.name}`;
    const { error: imgErr } = await supabase.storage.from("images").upload(imgPath, imgFile, { upsert: true });
    if (imgErr) return alert("Erreur upload image: " + imgErr.message);
  }

  // Afficher le lien
  const eventUrl = `${window.location.origin}/events/tables.html?event=${encodeURIComponent(username)}`;
  publicUrlDiv.innerHTML = isPrivate
    ? `üîí √âv√©nement priv√© cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</a></strong>`
    : `üåç √âv√©nement public cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</a></strong> <br><code>${publicOrSignedUrl}</code>`;

  alert("‚úÖ Upload termin√© !");
};

// Charger les uploads existants pour l‚Äôutilisateur
async function loadUserUploads() {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return;

  const { data: events } = await supabase.from("events").select("*").eq("user_id", user.id);
  if (!events || events.length === 0) return;

  events.forEach(e => {
    console.log("√âv√©nement existant :", e.username, e.uploaded_at, e.signed_url);
  });

  // Tu peux ensuite afficher dans un tableau ou div le CSV, images et URL
}

</script>

</body>
</html>
