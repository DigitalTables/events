<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DigitalTables ‚Äì Gestion des tables invit√©s</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <div class="container">
    <div class="logo-title">
      <img src="images/Logo.jpg" alt="Logo DigitalTables" class="logo" />
      <h1>DigitalTables</h1>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h2>Attribuez facilement la table de vos invit√©s</h2>
    <p>Un outil simple et rapide qui apporte une touche unique √† votre √©v√©nement.</p> 
  </div>
</section>

<div style="text-align:center; margin-top:1rem;">
  <button id="logout" style="display:none;">Se d√©connecter</button>
</div>

<!-- Section Auth -->
<div id="auth" style="text-align:center; margin-top:2rem;">
  <h3>Connexion / Inscription</h3>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Mot de passe" />
  <button id="signup">Cr√©er un compte</button>
  <button id="login">Se connecter</button>
</div>

<!-- Section Upload -->
<div id="upload" style="display:none; text-align:center; margin-top:2rem;">
  <div style="margin-bottom:1rem;">
    <label for="username" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Choisissez un identifiant public (visible dans l‚ÄôURL) :
    </label>
    <input type="text" id="username" placeholder="ex: johanna-martin-2026" />
    <div id="usernameStatus" style="margin-top:0.25rem; font-size:0.9rem;"></div>
  </div>

  <div style="margin-bottom:1rem;">
    <label>
      <input type="checkbox" id="privateCsv" /> CSV priv√© (acc√®s via mot de passe)
    </label>
  </div>

  <div id="passwordDiv" style="display:none; margin-bottom:1rem;">
    <label for="eventPassword" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Mot de passe de l‚Äô√©v√©nement :
    </label>
    <input type="password" id="eventPassword" placeholder="Mot de passe de l‚Äô√©v√©nement" />
  </div>

  <h3>Uploader ton CSV et tes images</h3>
  <input type="file" id="guests" accept=".csv" /><br><br>

  <div id="tablesImagesContainer">
    <p>Associez vos images aux tables :</p>
    <div id="tableImageRows"></div>
    <button id="addTableImageRow">Ajouter une table/image</button>
  </div>

  <br>
  <button id="send">Envoyer CSV</button>
  <button id="createSheet">Cr√©er Google Sheet</button>
  <button id="createSheetCore">Cr√©er Google Sheet Core</button>
  <button id="syncSheets">Sync Sheets Pool</button>
<button id="folder-test">Test folder</button>
  <button id="listFolderBtn">List Folder</button>

  
  <div id="publicUrl" style="margin-top:1rem; font-size:0.9rem; word-break:break-all;"></div>
</div>

  <div id="folderResult"></div>


<!-- Section Dashboard -->
<div id="dashboard" style="display:none; margin-top:3rem; padding: 0 2rem;">
  <h3 style="text-align:center; margin-bottom:1rem;">Vos √©v√©nements</h3>
  <div id="eventsContainer" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem;"></div>
</div>

<footer>
  <div class="container">
    <p>¬© 2025 DigitalTables. Tous droits r√©serv√©s.</p>
  </div>
</footer>

<script type="module">
import { supabase,SUPABASE_URL, getPrivateCsv } from './supabase.js';
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";

const authDiv = document.getElementById("auth");
const uploadDiv = document.getElementById("upload");
const logoutBtn = document.getElementById("logout");
const email = document.getElementById("email");
const password = document.getElementById("password");
const signup = document.getElementById("signup");
const login = document.getElementById("login");
const sendBtn = document.getElementById("send");
const createSheetBtn = document.getElementById("createSheet");
const createSheetCoreBtn = document.getElementById("createSheetCore");
const csvInput = document.getElementById("guests");
const usernameInput = document.getElementById("username");
const usernameStatus = document.getElementById("usernameStatus");
const privateCsvCheckbox = document.getElementById("privateCsv");
const passwordDiv = document.getElementById("passwordDiv");
const eventPasswordInput = document.getElementById("eventPassword");
const publicUrlDiv = document.getElementById("publicUrl");

const tableImageRows = document.getElementById("tableImageRows");
const addTableImageRowBtn = document.getElementById("addTableImageRow");
const dashboardDiv = document.getElementById("dashboard");

// Toggle mot de passe si priv√©
privateCsvCheckbox.addEventListener("change", () => {
  passwordDiv.style.display = privateCsvCheckbox.checked ? "block" : "none";
});

// Connexion / d√©connexion
function onLogin() {
  authDiv.style.display = "none";
  uploadDiv.style.display = "block";
  logoutBtn.style.display = "inline-block";
  dashboardDiv.style.display = "block";
  loadUserUploads();
}
function onLogout() {
  authDiv.style.display = "block";
  uploadDiv.style.display = "none";
  logoutBtn.style.display = "none";
  publicUrlDiv.textContent = "";
  dashboardDiv.style.display = "none";
}

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  onLogout();
};

// V√©rifie si d√©j√† connect√©
supabase.auth.getSession().then(({ data }) => {
  if (data.session) onLogin();
  else onLogout();
});
supabase.auth.onAuthStateChange((_event, session) => {
  if (session) onLogin();
  else onLogout();
});

// Authentification simplifi√©e
signup.onclick = async () => {
  const { data, error } = await supabase.auth.signUp({ email: email.value, password: password.value });
  if (error) return alert("Erreur : " + error.message);
  const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
  if (loginError) return alert("Erreur login : " + loginError.message);
  onLogin();
  alert("‚úÖ Compte cr√©√© et connect√© !");
};
login.onclick = async () => {
  const { error } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
  if (error) alert("Erreur : " + error.message);
  else onLogin();
};

// V√©rifie si un pseudo est d√©j√† utilis√©
async function checkPublicJsonExists(username) {
  const { data, error } = await supabase.storage.from("public-guests").list("", { search: `guests_${username}.json` });
  if (error) return false;
  return data.some(f => f.name === `guests_${username}.json`);
}

usernameInput.addEventListener("blur", async () => {
  const username = usernameInput.value.trim();
  if (!username) { usernameStatus.textContent = ""; return; }
  const exists = await checkPublicJsonExists(username);
  usernameStatus.textContent = exists ? "‚ùå Pseudo d√©j√† utilis√©" : "‚úÖ Disponible";
  usernameStatus.style.color = exists ? "red" : "green";
});

// Gestion des lignes table ‚Üí image
function addTableImageRow() {
  const div = document.createElement("div");
  div.style.marginBottom = "0.5rem";
  div.innerHTML = `
    <input type="text" placeholder="Nom de la table" style="width: 200px; margin-right:0.5rem;" />
    <input type="file" accept="image/*" />
    <button type="button" class="removeRow">‚ùå</button>
  `;
  div.querySelector(".removeRow").onclick = () => div.remove();
  tableImageRows.appendChild(div);
}
addTableImageRowBtn.addEventListener("click", addTableImageRow);

// ---- UPLOAD CSV ----
sendBtn.onclick = async () => {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return alert("‚ùå Tu dois √™tre connect√©.");

  const username = usernameInput.value.trim();
  if (!username) return alert("‚ùå Choisis un identifiant public.");

  const isPrivate = privateCsvCheckbox.checked;
  const eventPassword = eventPasswordInput.value.trim();
  if (isPrivate && !eventPassword) return alert("‚ùå D√©finis un mot de passe pour l‚Äô√©v√©nement priv√©.");

  const csvFile = csvInput.files[0];
  if (!csvFile) return alert("‚ùå Choisis un fichier CSV.");
  const text = await csvFile.text();
  const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
  const rows = parsed.data;

  // Upload CSV
  const csvPath = `guests_${username}.csv`;
  const { error: csvUpErr } = await supabase.storage.from("guests").upload(csvPath, new Blob([text], { type: "text/csv" }), { upsert: true });
  if (csvUpErr) return alert("Erreur upload CSV: " + csvUpErr.message);

  // Images mapping
  const imagesMapping = {};
  const tableImageDivs = tableImageRows.querySelectorAll("div");
  for (const div of tableImageDivs) {
    const tableName = div.querySelector("input[type='text']").value.trim();
    const imgFile = div.querySelector("input[type='file']").files[0];
    if (!tableName || !imgFile) continue;

    const safeFileName = imgFile.name
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, "_");

    const imgPath = `${username}/tables/${safeFileName}`;
    const { error: imgErr } = await supabase.storage.from("images").upload(imgPath, imgFile, { upsert: true });
    if (imgErr) return alert("Erreur upload image: " + imgErr.message);

    imagesMapping[tableName] = imgPath;
  }

  // Upload public JSON si n√©cessaire
  let publicOrSignedUrl = null;
  if (!isPrivate) {
    const publicJsonName = `guests_${username}.json`;
    const jsonBlob = new Blob([JSON.stringify(rows, null, 2)], { type: "application/json" });
    const { error: jsonUpErr } = await supabase.storage.from("public-guests").upload(publicJsonName, jsonBlob, { upsert: true });
    if (jsonUpErr) return alert("Erreur upload JSON: " + jsonUpErr.message);
    publicOrSignedUrl = `${SUPABASE_URL}/storage/v1/object/public/public-guests/${publicJsonName}`;
  } else {
    try {
      const signedUrl = await getPrivateCsv(username, eventPassword, user.id);
      publicOrSignedUrl = signedUrl;
    } catch(e) {
      return alert("Erreur g√©n√©ration URL sign√©e pour le CSV priv√©: " + e.message);
    }
  }

  // Enregistrer l‚Äô√©v√©nement + mapping images
  const { error: upsertErr } = await supabase.from("events").upsert({
    username,
    event_password: isPrivate ? eventPassword : null,
    signed_url: publicOrSignedUrl,
    is_private: isPrivate,
    user_id: user.id,
    uploaded_at: new Date(),
    images_mapping: imagesMapping
  }, { onConflict: "username" });
  if (upsertErr) return alert("Erreur enregistrement √©v√©nement: " + upsertErr.message);

  // Afficher le lien
  const eventUrl = `${window.location.origin}/events/tables.html?event=${encodeURIComponent(username)}`;
  publicUrlDiv.innerHTML = isPrivate
    ? `üîí √âv√©nement priv√© cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</a></strong>`
    : `üåç √âv√©nement public cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</a></strong> <br><code>${publicOrSignedUrl}</code>`;

  alert("‚úÖ Upload termin√© !");
  loadUserUploads();
};

// ---- CR√âER GOOGLE SHEET ----
createSheetBtn.onclick = async () => {
  try {
    // 1) Connexion OAuth dans une popup
    const accessToken = await googleSignInPopup();

    // 2) Cr√©ation d'une Google Sheet
    const sheetRes = await fetch(
      "https://sheets.googleapis.com/v4/spreadsheets",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          properties: {
            title: "DigitalTables - Votre table"
          },
          sheets: [
            {
              properties: { title: "Ma Table" },
              data: [
                {
                  startRow: 0,
                  startColumn: 0,
                  rowData: [
                    {
                      values: [
                        { userEnteredValue: { stringValue: "name" } },
                        { userEnteredValue: { stringValue: "table" } },
                        { userEnteredValue: { stringValue: "message" } }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        })
      }
    );

    if (!sheetRes.ok) {
      console.error(await sheetRes.text());
      throw new Error("Erreur lors de la cr√©ation de la Google Sheet");
    }

    const sheetData = await sheetRes.json();
    const spreadsheetId = sheetData.spreadsheetId;
    const sheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`;

    // 3) Enregistrement dans Supabase
    // ‚ö†Ô∏è Adapte la table/colonnes ci-dessous √† ta base
    const { data, error } = await supabase
      .from("events")
      .insert({
        google_sheet_url: sheetUrl,
        created_at: new Date().toISOString()
      });

    if (error) throw error;

    // 4) Redirection vers la Sheet
    window.location.href = sheetUrl;

  } catch (err) {
    console.error(err);
    alert("Erreur: " + err.message);
  }
};


// ---- CR√âER GOOGLE SHEET Core Function ----
createSheetCoreBtn.onclick = async () => {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return alert("‚ùå Tu dois √™tre connect√©.");

  const username = usernameInput.value.trim();
  if (!username) return alert("‚ùå Choisis un identifiant public.");

  const session = await supabase.auth.getSession();
  const accessToken = session.data.session?.access_token;

  createSheetCoreBtn.textContent = "Assignation en cours...";
  createSheetCoreBtn.disabled = true;

  try {
   const res = await fetch(
  `${SUPABASE_URL}/functions/v1/assign-google-sheetCore`,
  {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${accessToken}`,
    },
    body: JSON.stringify({
      username,
      user_id: user.id
    })
  }
);

    const data = await res.json();

    if (!res.ok) throw new Error(data.error || "Erreur assignation");

    // üî• Affichage direct du lien Google Sheet
    const sheetUrl = `https://docs.google.com/spreadsheets/d/${data.sheet_id}/edit`;

    alert(`‚úÖ Google Sheet assign√©e !`);
    publicUrlDiv.innerHTML += `
      <br><br>
      üìä Google Sheet li√©e :
      <a href="${sheetUrl}" target="_blank">${sheetUrl}</a>
    `;

    // Mise √† jour de la DB locale affich√©e
    loadUserUploads();

  } catch (err) {
    console.error(err);
    alert("‚ùå Erreur assignation : " + err.message);
  } finally {
    createSheetCoreBtn.textContent = "Cr√©er Google Sheet Core";
    createSheetCoreBtn.disabled = false;
  }
};

    
//Sync folder google sheet and database
  const syncBtn = document.getElementById("syncSheets");

syncBtn.onclick = async () => {
  const session = await supabase.auth.getSession();
  const accessToken = session.data.session?.access_token;

  if (!accessToken) return alert("‚ùå Connecte-toi d'abord.");

  syncBtn.textContent = "Sync...";
  syncBtn.disabled = true;

  try {
    const res = await fetch(
      "https://corsproxy.io/?" +
      encodeURIComponent(`${SUPABASE_URL}/functions/v1/sync-google-sheets-pool`),
      {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        }
      }
    );

    const data = await res.json();

    if (!res.ok) {
  console.error("SYNC RAW ERROR:", data);
  throw new Error(data.error || JSON.stringify(data));
}


    alert("‚úÖ Sync termin√©e : " + data.count + " sheets mises √† jour.");
    
  } catch (err) {
    alert("‚ùå Sync error : " + err.message);
  } finally {
    syncBtn.textContent = "Sync Sheets Pool";
    syncBtn.disabled = false;
  }
};


  

  
//Folder test
  const folderTestBtn = document.getElementById("folder-test");

folderTestBtn.onclick = async () => {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return alert("‚ùå Tu dois √™tre connect√©.");

  const session = await supabase.auth.getSession();
  const accessToken = session.data.session?.access_token;
  if (!accessToken) return alert("‚ùå Token introuvable, reconnecte-toi.");

  try {
    const res = await fetch(
      "https://corsproxy.io/?" +
      encodeURIComponent(`${SUPABASE_URL}/functions/v1/folder-test`),
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${accessToken}`,
        },
        body: JSON.stringify({})
      }
    );

    const data = await res.json();
    if (!res.ok || data.error)
      return alert("‚ùå Erreur cr√©ation Dossier : " + (data.error || "inconnue"));

    alert(`‚úÖ Dossier cr√©√© !\nID : ${data.id}\nNom : ${data.name}\nOwner : ${data.owner}`);

  } catch (err) {
    alert("Erreur fetch : " + err.message);
  }
};



// ---- LIST FOLDER ----

const listFolderBtn = document.getElementById("listFolderBtn");
const resultBox = document.getElementById("folderResult");

listFolderBtn.addEventListener("click", listFolder);

async function listFolder() {

  // üî• R√©cup√©rer utilisateur (obligatoire)
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;

  if (!user) {
    resultBox.textContent = "‚ùå Tu dois √™tre connect√©.";
    return;
  }

  const session = await supabase.auth.getSession();
  const accessToken = session.data.session?.access_token;

  if (!accessToken) {
    resultBox.textContent = "‚ùå Token introuvable, reconnecte-toi.";
    return;
  }

  try {
    const res = await fetch(
      "https://corsproxy.io/?" +
        encodeURIComponent(`${SUPABASE_URL}/functions/v1/list-folder`),
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${accessToken}`,
        }
      }
    );

    const data = await res.json();

    if (!res.ok) {
      resultBox.textContent = `‚ùå Erreur : ${JSON.stringify(data, null, 2)}`;
      return;
    }

    // Si aucun dossier
    if (!data.files || data.files.length === 0) {
      resultBox.innerHTML = "<p>Aucun dossier trouv√©.</p>";
      return;
    }

    // JSON brut dans un <pre> pour conserver la mise en forme
    resultBox.innerHTML = `<pre>${JSON.stringify(data.files, null, 2)}</pre>`;

  } catch (err) {
    resultBox.textContent = `‚ùå Erreur fetch : ${err.message}`;
  }
}
// Dashboard
async function loadUserUploads() {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return;

  const { data: events } = await supabase
    .from("events")
    .select("*")
    .eq("user_id", user.id)
    .order('uploaded_at', { ascending: false });

  const container = document.getElementById("eventsContainer");
  container.innerHTML = "";
  if (!events || events.length === 0) {
    container.textContent = "Vous n'avez aucun √©v√©nement pour l'instant.";
    return;
  }

  events.forEach(e => {
    const card = document.createElement("div");
    card.style.background = "rgba(255,255,255,0.8)";
    card.style.borderRadius = "12px";
    card.style.padding = "1rem";
    card.style.boxShadow = "0 4px 8px rgba(0,0,0,0.1)";
    card.style.display = "flex";
    card.style.flexDirection = "column";
    card.style.gap = "0.5rem";

    const title = document.createElement("h4");
    title.textContent = e.username;
    title.style.margin = "0";
    title.style.fontFamily = "'Playfair Display', serif";
    title.style.color = "#2e1f17";
    card.appendChild(title);

    const date = document.createElement("div");
    date.textContent = "üìÖ " + new Date(e.uploaded_at).toLocaleString();
    date.style.fontSize = "0.9rem";
    card.appendChild(date);

    // CSV
    const csvLink = document.createElement("a");
    csvLink.textContent = "T√©l√©charger CSV";
    csvLink.style.display = "inline-block";
    csvLink.style.padding = "0.4rem 0.6rem";
    csvLink.style.background = "#f5eee5";
    csvLink.style.border = "1px solid #d0bfae";
    csvLink.style.borderRadius = "6px";
    csvLink.style.textDecoration = "none";
    csvLink.style.color = "#3e2f27";
    csvLink.style.fontWeight = "600";
    csvLink.style.fontSize = "0.9rem";

    if (!e.is_private) {
      csvLink.href = `${SUPABASE_URL}/storage/v1/object/public/guests/guests_${e.username}.csv`;
      csvLink.target = "_blank";
    } else {
      csvLink.href = "#";
      csvLink.onclick = async () => {
        try {
          const signedUrl = await getPrivateCsv(e.username, e.event_password, user.id);
          window.open(signedUrl, "_blank");
        } catch(err) {
          alert("Erreur r√©cup√©ration CSV priv√©: "+err.message);
        }
      };
    }
    card.appendChild(csvLink);

    // Lien complet
    const link = document.createElement("a");
    link.href = `${window.location.origin}/events/tables.html?event=${encodeURIComponent(e.username)}`;
    link.textContent = "Lien √©v√©nement";
    link.style.display = "inline-block";
    link.style.padding = "0.4rem 0.6rem";
    link.style.background = "#f5eee5";
    link.style.border = "1px solid #d0bfae";
    link.style.borderRadius = "6px";
    link.style.textDecoration = "none";
    link.style.color = "#3e2f27";
    link.style.fontWeight = "600";
    link.style.fontSize = "0.9rem";
    link.style.marginTop = "0.5rem";
    link.target = "_blank";
    card.appendChild(link);

    // ‚úÖ Lien Google Sheet (si disponible)
    if (e.google_sheet_url) {
      const sheetLink = document.createElement("a");
      sheetLink.href = e.google_sheet_url;
      sheetLink.textContent = "üìä Google Sheet";
      sheetLink.target = "_blank";
      sheetLink.style.display = "inline-block";
      sheetLink.style.marginTop = "0.5rem";
      card.appendChild(sheetLink);
    }

    container.appendChild(card);
  });
}
</script>
</body>
</html>
