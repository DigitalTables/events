<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DigitalTables ‚Äì Gestion des tables invit√©s</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; background: #fffdfb; }
    th, td { border: 1px solid #d0bfae; padding: 8px; text-align: center; }
    th { background: #f5eee5; }
    a { color: #2e1f17; text-decoration: none; font-weight: bold; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<header>
  <div class="container">
    <div class="logo-title">
      <img src="images/Logo.jpg" alt="Logo DigitalTables" class="logo" />
      <h1>DigitalTables</h1>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h2>Attribuez facilement la table de vos invit√©s</h2>
    <p>Un outil simple et rapide qui apporte une touche unique √† votre √©v√©nement.</p> 
  </div>
</section>

<div style="text-align:center; margin-top:1rem;">
  <button id="logout" style="display:none;">Se d√©connecter</button>
</div>

<!-- Section Auth -->
<div id="auth" style="text-align:center; margin-top:2rem;">
  <h3>Connexion / Inscription</h3>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Mot de passe" />
  <button id="signup">Cr√©er un compte</button>
  <button id="login">Se connecter</button>
</div>

<!-- Section Upload + Dashboard -->
<div id="upload" style="display:none; text-align:center; margin-top:2rem;">
  <div style="margin-bottom:1rem;">
    <label for="username" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Choisissez un identifiant public (visible dans l‚ÄôURL) :
    </label>
    <input type="text" id="username" placeholder="ex: johanna-martin-2026" />
    <div id="usernameStatus" style="margin-top:0.25rem; font-size:0.9rem;"></div>
  </div>

  <div style="margin-bottom:1rem;">
    <label>
      <input type="checkbox" id="privateCsv" /> CSV priv√© (acc√®s via mot de passe)
    </label>
  </div>

  <div id="passwordDiv" style="display:none; margin-bottom:1rem;">
    <label for="eventPassword" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Mot de passe de l‚Äô√©v√©nement :
    </label>
    <input type="password" id="eventPassword" placeholder="Mot de passe de l‚Äô√©v√©nement" />
  </div>

  <h3>Uploader CSV et images pour vos tables</h3>
  <input type="file" id="guests" accept=".csv" /><br><br>
  <input type="file" id="images" accept="image/*" multiple /><br><br>
  <button id="send">Envoyer</button>

  <div id="publicUrl" style="margin-top:1rem; font-size:0.9rem; word-break:break-all;"></div>

  <h3 style="margin-top:2rem;">Dashboard de vos √©v√©nements</h3>
  <table id="dashboard">
    <thead>
      <tr>
        <th>Pseudo</th>
        <th>Priv√© / Public</th>
        <th>Date / Heure</th>
        <th>Lien complet</th>
        <th>CSV</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<footer>
  <div class="container">
    <p>¬© 2025 DigitalTables. Tous droits r√©serv√©s.</p>
  </div>
</footer>

<script type="module">
import { supabase, getPrivateCsv, getEventImagesMapping, getUserEvents } from './supabase.js';
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";

const authDiv = document.getElementById("auth");
const uploadDiv = document.getElementById("upload");
const logoutBtn = document.getElementById("logout");
const email = document.getElementById("email");
const password = document.getElementById("password");
const signup = document.getElementById("signup");
const login = document.getElementById("login");
const sendBtn = document.getElementById("send");
const csvInput = document.getElementById("guests");
const imagesInput = document.getElementById("images");
const usernameInput = document.getElementById("username");
const usernameStatus = document.getElementById("usernameStatus");
const privateCsvCheckbox = document.getElementById("privateCsv");
const passwordDiv = document.getElementById("passwordDiv");
const eventPasswordInput = document.getElementById("eventPassword");
const publicUrlDiv = document.getElementById("publicUrl");
const dashboardTbody = document.querySelector("#dashboard tbody");

// Toggle mot de passe si priv√©
privateCsvCheckbox.addEventListener("change", () => {
  passwordDiv.style.display = privateCsvCheckbox.checked ? "block" : "none";
});

// Connexion / d√©connexion
function onLogin() {
  authDiv.style.display = "none";
  uploadDiv.style.display = "block";
  logoutBtn.style.display = "inline-block";
  loadDashboard();
}
function onLogout() {
  authDiv.style.display = "block";
  uploadDiv.style.display = "none";
  logoutBtn.style.display = "none";
  publicUrlDiv.textContent = "";
  dashboardTbody.innerHTML = "";
}

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  onLogout();
};

// V√©rifie si d√©j√† connect√©
supabase.auth.getSession().then(({ data }) => {
  if (data.session) onLogin();
  else onLogout();
});
supabase.auth.onAuthStateChange((_event, session) => {
  if (session) onLogin();
  else onLogout();
});

// Auth simplifi√©e
signup.onclick = async () => {
  const { data, error } = await supabase.auth.signUp({ email: email.value, password: password.value });
  if (error) return alert("Erreur : " + error.message);

  const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
  if (loginError) return alert("Erreur login : " + loginError.message);

  onLogin();
  alert("‚úÖ Compte cr√©√© et connect√© !");
};
login.onclick = async () => {
  const { error } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
  if (error) alert("Erreur : " + error.message);
  else onLogin();
};

// Dashboard
async function loadDashboard() {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return;

  try {
    const events = await getUserEvents(user.id);
    dashboardTbody.innerHTML = "";
    for (const ev of events) {
      const isPrivate = ev.is_private;
      const url = `${window.location.origin}/events/tables.html?event=${encodeURIComponent(ev.username)}`;
      let csvLink = "#";
      if (isPrivate) {
        csvLink = await getPrivateCsv(ev.username, ev.event_password, user.id);
      } else {
        csvLink = `${supabase.supabaseUrl}/storage/v1/object/public/guests/guests_${ev.username}.csv`;
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ev.username}</td>
        <td>${isPrivate ? "Priv√©" : "Public"}</td>
        <td>${new Date(ev.uploaded_at).toLocaleString()}</td>
        <td><a href="${url}" target="_blank">${url}</a></td>
        <td><a href="${csvLink}" target="_blank">T√©l√©charger CSV</a></td>
      `;
      dashboardTbody.appendChild(tr);
    }
  } catch(e) {
    console.error(e);
    alert("Erreur chargement dashboard : " + e.message);
  }
}

// Upload CSV et images
sendBtn.onclick = async () => {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return alert("‚ùå Tu dois √™tre connect√©.");

  const username = usernameInput.value.trim();
  if (!username) return alert("‚ùå Choisis un identifiant public.");

  const isPrivate = privateCsvCheckbox.checked;
  const eventPassword = eventPasswordInput.value.trim();
  if (isPrivate && !eventPassword) return alert("‚ùå D√©finis un mot de passe pour l‚Äô√©v√©nement priv√©.");

  const csvFile = csvInput.files[0];
  if (!csvFile) return alert("‚ùå Choisis un fichier CSV.");
  const csvText = await csvFile.text();
  const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });

  // Upload CSV dans guests (priv√©)
  const csvPath = `guests_${username}.csv`;
  const { error: csvUpErr } = await supabase.storage.from("guests").upload(csvPath, new Blob([csvText], { type: "text/csv" }), { upsert: true });
  if (csvUpErr) return alert("Erreur upload CSV: " + csvUpErr.message);

  // Mapping images
  const imgs = imagesInput.files;
  const imagesMapping = {};
  for (const img of imgs) {
    const safeName = img.name.replace(/[^a-z0-9\-_\.]/gi, "_");
    imagesMapping[img.name.split(".")[0]] = safeName;
    const { error: imgErr } = await supabase.storage.from("images").upload(`${username}/${safeName}`, img, { upsert: true });
    if (imgErr) return alert("Erreur upload image: " + imgErr.message);
  }

  // URL √©v√©nement
  let publicOrSignedUrl = null;
  if (!isPrivate) {
    const jsonBlob = new Blob([JSON.stringify(parsed.data, null, 2)], { type: "application/json" });
    const { error: jsonUpErr } = await supabase.storage.from("public-guests").upload(`guests_${username}.json`, jsonBlob, { upsert: true });
    if (jsonUpErr) return alert("Erreur upload JSON public: " + jsonUpErr.message);
    publicOrSignedUrl = `${supabase.supabaseUrl}/storage/v1/object/public/public-guests/guests_${username}.json`;
  } else {
    try {
      publicOrSignedUrl = await getPrivateCsv(username, eventPassword, user.id);
    } catch(e) {
      return alert("Erreur g√©n√©ration URL sign√©e pour CSV priv√©: " + e.message);
    }
  }

  // Upsert √©v√©nement
  const { error: upsertErr } = await supabase.from("events").upsert({
    username,
    event_password: isPrivate ? eventPassword : null,
    signed_url: publicOrSignedUrl,
    is_private: isPrivate,
    user_id: user.id,
    uploaded_at: new Date().toISOString(),
    images_mapping: imagesMapping
  }, { onConflict: "username" });
  if (upsertErr) return alert("Erreur enregistrement √©v√©nement: " + upsertErr.message);

  // Afficher lien
  const eventUrl = `${window.location.origin}/events/tables.html?event=${encodeURIComponent(username)}`;
  publicUrlDiv.innerHTML = isPrivate
    ? `üîí √âv√©nement priv√© cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</a></strong>`
    : `üåç √âv√©nement public cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</strong> <br><code>${publicOrSignedUrl}</code>`;

  alert("‚úÖ Upload termin√© !");
  loadDashboard();
};
</script>

</body>
</html>
