<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DigitalTables ‚Äì Gestion des tables invit√©s</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <div class="container">
    <div class="logo-title">
      <img src="images/Logo.jpg" alt="Logo DigitalTables" class="logo" />
      <h1>DigitalTables</h1>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h2>Attribuez facilement la table de vos invit√©s</h2>
    <p>Un outil simple et rapide qui apporte une touche unique √† votre √©v√©nement.</p> 
  </div>
</section>

<div style="text-align:center; margin-top:1rem;">
  <button id="logout" style="display:none;">Se d√©connecter</button>
</div>

<!-- Section Auth -->
<div id="auth" style="text-align:center; margin-top:2rem;">
  <h3>Connexion / Inscription</h3>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Mot de passe" />
  <button id="signup">Cr√©er un compte</button>
  <button id="login">Se connecter</button>
</div>

<!-- Section Create Event (choice CSV or Google Sheet) -->
<div id="upload" style="display:none; text-align:center; margin-top:2rem;">
  <div style="margin-bottom:1rem;">
    <label for="username" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Choisissez un identifiant public (visible dans l‚ÄôURL) :
    </label>
    <input type="text" id="username" placeholder="ex: johanna-martin-2026" />
    <div id="usernameStatus" style="margin-top:0.25rem; font-size:0.9rem;"></div>
  </div>

  <div style="margin-bottom:1rem;">
    <label>
      <input type="checkbox" id="privateCsv" /> CSV priv√© (acc√®s via mot de passe)
    </label>
  </div>

  <div id="passwordDiv" style="display:none; margin-bottom:1rem;">
    <label for="eventPassword" style="display:block; font-weight:700; margin-bottom:0.25rem;">
      Mot de passe de l‚Äô√©v√©nement :
    </label>
    <input type="password" id="eventPassword" placeholder="Mot de passe de l‚Äô√©v√©nement" />
  </div>

  <div style="margin:1rem 0;">
    <label style="font-weight:700; display:block; margin-bottom:0.5rem;">Mode de cr√©ation :</label>
    <label><input type="radio" name="mode" value="csv" id="modeCsv" checked /> Cr√©er via CSV</label>
    <label style="margin-left:1rem;"><input type="radio" name="mode" value="sheet" id="modeSheet" /> Cr√©er via Google Sheet</label>
    <div style="font-size:0.9rem; color:#666; margin-top:0.25rem;">
      (Choisissez l'une des deux options : <strong>CSV</strong> upload ou <strong>Google Sheet</strong> depuis le pool.)
    </div>
  </div>

  <h3 id="uploadTitle">Uploader ton CSV et tes images</h3>
  <input type="file" id="guests" accept=".csv" /><br><br>

  <div id="tablesImagesContainer">
    <p>Associez vos images aux tables (optionnel) :</p>
    <div id="tableImageRows"></div>
    <button id="addTableImageRow">Ajouter une table/image</button>
  </div>

  <br>
  <button id="createEventBtn">Cr√©er l'√©v√©nement</button>
  <button id="syncSheets">Sync Sheets Pool</button>
  <button id="folder-test">Test folder</button>
  <button id="listFolderBtn">List Folder</button>

  <div id="publicUrl" style="margin-top:1rem; font-size:0.9rem; word-break:break-all;"></div>
</div>

<div id="folderResult"></div>

<!-- Section Dashboard -->
<div id="dashboard" style="display:none; margin-top:3rem; padding: 0 2rem;">
  <h3 style="text-align:center; margin-bottom:1rem;">Vos √©v√©nements</h3>
  <div id="eventsContainer" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem;"></div>
</div>

<footer>
  <div class="container">
    <p>¬© 2025 DigitalTables. Tous droits r√©serv√©s.</p>
  </div>
</footer>

<script type="module">
/* ----------------------------
   IMPORTS SUPABASE + PAPAPARSE
---------------------------- */
import { supabase, SUPABASE_URL, getPrivateCsv } from './supabase.js';
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";

/* ----------------------------
   DOM ELEMENTS
---------------------------- */
const authDiv = document.getElementById("auth");
const uploadDiv = document.getElementById("upload");
const logoutBtn = document.getElementById("logout");
const email = document.getElementById("email");
const password = document.getElementById("password");
const signup = document.getElementById("signup");
const login = document.getElementById("login");
const createEventBtn = document.getElementById("createEventBtn");
const csvInput = document.getElementById("guests");
const usernameInput = document.getElementById("username");
const usernameStatus = document.getElementById("usernameStatus");
const privateCsvCheckbox = document.getElementById("privateCsv");
const passwordDiv = document.getElementById("passwordDiv");
const eventPasswordInput = document.getElementById("eventPassword");
const publicUrlDiv = document.getElementById("publicUrl");
const tableImageRows = document.getElementById("tableImageRows");
const addTableImageRowBtn = document.getElementById("addTableImageRow");
const dashboardDiv = document.getElementById("dashboard");
const modeCsv = document.getElementById("modeCsv");
const modeSheet = document.getElementById("modeSheet");
const uploadTitle = document.getElementById("uploadTitle");

/* ----------------------------
   TOGGLE PASSWORD IF PRIVATE
---------------------------- */
privateCsvCheckbox.addEventListener("change", () => {
  passwordDiv.style.display = privateCsvCheckbox.checked ? "block" : "none";
});

/* ----------------------------
   MODE SWITCH (CSV vs SHEET)
---------------------------- */
function updateModeUI() {
  if (modeCsv.checked) {
    uploadTitle.textContent = "Uploader ton CSV et tes images";
    csvInput.style.display = "inline-block";
  } else {
    uploadTitle.textContent = "Ajouter des images (optionnel) puis cr√©er la Google Sheet";
    csvInput.style.display = "none";
  }
}
modeCsv.addEventListener("change", updateModeUI);
modeSheet.addEventListener("change", updateModeUI);
updateModeUI();

/* ----------------------------
   LOGIN / LOGOUT
---------------------------- */
function onLogin() {
  authDiv.style.display = "none";
  uploadDiv.style.display = "block";
  logoutBtn.style.display = "inline-block";
  dashboardDiv.style.display = "block";
  loadUserUploads();
}
function onLogout() {
  authDiv.style.display = "block";
  uploadDiv.style.display = "none";
  logoutBtn.style.display = "none";
  publicUrlDiv.textContent = "";
  dashboardDiv.style.display = "none";
}

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  onLogout();
};

/* ----------------------------
   AUTH STATUS CHECK
---------------------------- */
supabase.auth.getSession().then(({ data }) => {
  if (data.session) onLogin();
  else onLogout();
});
supabase.auth.onAuthStateChange((_event, session) => {
  if (session) onLogin();
  else onLogout();
});

/* ----------------------------
   SIGNUP / LOGIN
---------------------------- */
signup.onclick = async () => {
  const { error } = await supabase.auth.signUp({
    email: email.value,
    password: password.value
  });
  if (error) return alert("Erreur : " + error.message);

  const { error: loginError } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (loginError) return alert("Erreur login : " + loginError.message);

  onLogin();
  alert("Compte cr√©√© et connect√© !");
};
login.onclick = async () => {
  const { error } = await supabase.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) alert("Erreur : " + error.message);
  else onLogin();
};

/* ----------------------------
   CHECK USERNAME EXISTENCE
---------------------------- */
async function checkPublicJsonExists(username) {
  const { data, error } = await supabase.storage
    .from("public-guests")
    .list("", { search: `guests_${username}.json` });
  if (error) return false;
  return data.some(f => f.name === `guests_${username}.json`);
}
usernameInput.addEventListener("blur", async () => {
  const username = usernameInput.value.trim();
  if (!username) return usernameStatus.textContent = "";
  const exists = await checkPublicJsonExists(username);
  usernameStatus.textContent = exists ? "‚ùå Pseudo d√©j√† utilis√©" : "Disponible ‚úî";
  usernameStatus.style.color = exists ? "red" : "green";
});

/* ----------------------------
   ADD TABLE ‚Üí IMAGE ROW
---------------------------- */
function addTableImageRow() {
  const div = document.createElement("div");
  div.style.marginBottom = "0.5rem";
  div.innerHTML = `
    <input type="text" placeholder="Nom de la table" style="width: 200px; margin-right:0.5rem;" />
    <input type="file" accept="image/*" />
    <button type="button" class="removeRow">‚ùå</button>
  `;
  div.querySelector(".removeRow").onclick = () => div.remove();
  tableImageRows.appendChild(div);
}
addTableImageRowBtn.addEventListener("click", addTableImageRow);

/* ----------------------------
   HELPERS: upload images mapping
---------------------------- */
async function uploadImagesMapping(username) {
  const imagesMapping = {};
  const divs = tableImageRows.querySelectorAll("div");
  for (const div of divs) {
    const tableName = div.querySelector("input[type='text']").value.trim();
    const imgFile = div.querySelector("input[type='file']").files[0];
    if (!tableName || !imgFile) continue;
    const cleanName = imgFile.name.normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, "_");
    const imgPath = `${username}/tables/${cleanName}`;
    const { error: imgErr } = await supabase.storage.from("images").upload(imgPath, imgFile, { upsert: true });
    if (imgErr) throw new Error("Erreur upload image: " + imgErr.message);
    imagesMapping[tableName] = imgPath;
  }
  return imagesMapping;
}

/* ----------------------------
   CREATE EVENT (CSV MODE or SHEET MODE)
---------------------------- */
createEventBtn.onclick = async () => {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return alert("‚ùå Connecte-toi.");

  const username = usernameInput.value.trim();
  if (!username) return alert("‚ùå Choisis un identifiant public.");

  const isPrivate = privateCsvCheckbox.checked;
  const eventPassword = eventPasswordInput.value.trim();
  if (isPrivate && !eventPassword) return alert("‚ùå D√©finis un mot de passe pour l‚Äô√©v√©nement priv√©.");

  const mode = modeCsv.checked ? "csv" : "sheet";

  // Upload images mapping (works in both modes)
  let imagesMapping = {};
  try {
    imagesMapping = await uploadImagesMapping(username);
  } catch (e) {
    return alert(e.message);
  }

  if (mode === "csv") {
    // CSV flow: require CSV file
    const csvFile = csvInput.files[0];
    if (!csvFile) return alert("‚ùå Choisis un fichier CSV.");

    createEventBtn.textContent = "Cr√©ation en cours...";
    createEventBtn.disabled = true;

    try {
      const text = await csvFile.text();
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      const rows = parsed.data;

      // Upload CSV to storage
      const csvPath = `guests_${username}.csv`;
      const { error: csvUpErr } = await supabase.storage
        .from("guests")
        .upload(csvPath, new Blob([text], { type: "text/csv" }), { upsert: true });
      if (csvUpErr) throw new Error("Erreur upload CSV: " + csvUpErr.message);

      // If public ‚Üí upload JSON version to bucket public-guests
      let publicOrSignedUrl = null;
      if (!isPrivate) {
        const publicJson = `guests_${username}.json`;
        const jsonBlob = new Blob([JSON.stringify(rows, null, 2)], {
          type: "application/json"
        });
        const { error: jsonUpErr } = await supabase.storage.from("public-guests")
          .upload(publicJson, jsonBlob, { upsert: true });
        if (jsonUpErr) throw new Error("Erreur upload JSON: " + jsonUpErr.message);
        publicOrSignedUrl = `${SUPABASE_URL}/storage/v1/object/public/public-guests/${publicJson}`;
      } else {
        // private => store signed url placeholder; actual signed url generated by function getPrivateCsv when needed
        publicOrSignedUrl = null;
      }

      // Upsert event and get record (so we have event id)
      const eventObj = {
        username,
        event_password: isPrivate ? eventPassword : null,
        signed_url: publicOrSignedUrl,
        is_private: isPrivate,
        user_id: user.id,
        uploaded_at: new Date().toISOString(),
        images_mapping: imagesMapping
      };

      const { data: insertedEvent, error: upsertErr } = await supabase
        .from("events")
        .upsert(eventObj, { onConflict: "username" })
        .select()
        .single();
      if (upsertErr) throw upsertErr;

      // Done: display link
      const eventUrl = `${window.location.origin}/events/tables.html?event=${encodeURIComponent(username)}`;
      publicUrlDiv.innerHTML = isPrivate
        ? `üîí √âv√©nement priv√© cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</a></strong>`
        : `üåç √âv√©nement public cr√©√© : <br><strong><a href="${eventUrl}" target="_blank">${eventUrl}</a></strong> <br><code>${publicOrSignedUrl}</code>`;

      alert("‚úÖ √âv√©nement cr√©√© via CSV !");
      loadUserUploads();

    } catch (err) {
      alert("‚ùå Erreur cr√©ation √©v√©nement CSV : " + (err.message || err));
    } finally {
      createEventBtn.textContent = "Cr√©er l'√©v√©nement";
      createEventBtn.disabled = false;
    }

  } else {
    // SHEET flow: create event record first (no CSV), then call edge function to assign sheet
    createEventBtn.textContent = "Cr√©ation Google Sheet...";
    createEventBtn.disabled = true;

    try {
      // 1) create event row (so we have event_id)
      const eventObj = {
        username,
        event_password: isPrivate ? eventPassword : null,
        signed_url: null,
        is_private: isPrivate,
        user_id: user.id,
        uploaded_at: new Date().toISOString(),
        images_mapping: imagesMapping
      };
      const { data: insertedEvent, error: upsertErr } = await supabase
        .from("events")
        .upsert(eventObj, { onConflict: "username" })
        .select()
        .single();
      if (upsertErr) throw upsertErr;
      const event_id = insertedEvent.id;

      // 2) call edge function assign-google-sheet
      const session = await supabase.auth.getSession();
      const accessToken = session.data.session?.access_token;
      if (!accessToken) throw new Error("Token introuvable, reconnecte-toi.");

      const res = await fetch(
        `${SUPABASE_URL}/functions/v1/assign-google-sheet`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${accessToken}`
          },
          body: JSON.stringify({
            username,
            user_id: user.id,
            event_id,
            is_public_event: !isPrivate
          })
        }
      );
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || JSON.stringify(data));

      // 3) update event with google_sheet_url if function didn't already
      const sheetEditUrl = `https://docs.google.com/spreadsheets/d/${data.sheet_id}/edit`;
      const publicCsvUrl = data.is_public_event ? `https://docs.google.com/spreadsheets/d/${data.sheet_id}/gviz/tq?tqx=out:csv&sheet=Invit√©s` : null;

      const { error: updateErr } = await supabase
        .from("events")
        .update({
          google_sheet_url: sheetEditUrl,
          signed_url: publicCsvUrl || null,
          updated_at: new Date().toISOString()
        })
        .eq("id", event_id);
      if (updateErr) console.warn("Warning updating event after sheet assign:", updateErr.message);

      // 4) show link
      publicUrlDiv.innerHTML = `
        üìä Google Sheet cr√©√©e : <br>
        <a href="${sheetEditUrl}" target="_blank">${sheetEditUrl}</a>
        ${publicCsvUrl ? `<br><code>${publicCsvUrl}</code>` : ""}
      `;
      alert("‚úÖ Google Sheet assign√©e !");
      loadUserUploads();

    } catch (err) {
      alert("‚ùå Erreur cr√©ation Google Sheet : " + (err.message || err));
    } finally {
      createEventBtn.textContent = "Cr√©er l'√©v√©nement";
      createEventBtn.disabled = false;
    }
  }
};

/* ----------------------------
   SYNC SHEETS POOL
---------------------------- */
const syncBtn = document.getElementById("syncSheets");
syncBtn.onclick = async () => {
  const session = await supabase.auth.getSession();
  const accessToken = session.data.session?.access_token;
  if (!accessToken) return alert("‚ùå Connecte-toi.");

  syncBtn.textContent = "Sync...";
  syncBtn.disabled = true;

  try {
    const res = await fetch(
      `${SUPABASE_URL}/functions/v1/sync-google-sheets-pool`,
      {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        }
      }
    );
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || JSON.stringify(data));
    alert(`‚úÖ Sync termin√©e : ${data.count || 0} sheets mises √† jour.`);
  } catch (err) {
    alert("‚ùå Sync error : " + err.message);
  } finally {
    syncBtn.textContent = "Sync Sheets Pool";
    syncBtn.disabled = false;
  }
};

/* ----------------------------
   FOLDER TEST
---------------------------- */
document.getElementById("folder-test").onclick = async () => {
  const session = await supabase.auth.getSession();
  const accessToken = session.data.session?.access_token;
  if (!accessToken) return alert("Connecte-toi.");

  try {
    const res = await fetch(`${SUPABASE_URL}/functions/v1/folder-test`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/json"
      }
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || JSON.stringify(data));
    alert(`‚úÖ Dossier cr√©√© : ${data.name} (ID: ${data.id})`);
  } catch (err) {
    alert("Erreur folder-test: " + (err.message || err));
  }
};

/* ----------------------------
   LIST FOLDER
---------------------------- */
document.getElementById("listFolderBtn").onclick = async () => {
  const resultBox = document.getElementById("folderResult");
  const session = await supabase.auth.getSession();
  const accessToken = session.data.session?.access_token;
  if (!accessToken) return resultBox.textContent = "‚ùå Connecte-toi.";

  try {
    const res = await fetch(`${SUPABASE_URL}/functions/v1/list-folder`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/json"
      }
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || JSON.stringify(data));
    resultBox.innerHTML = `<pre>${JSON.stringify(data.files, null, 2)}</pre>`;
  } catch (err) {
    resultBox.textContent = `‚ùå Erreur fetch : ${err.message || err}`;
  }
};

function formatDateWithTimeZone(dateString) {
  return new Date(dateString).toLocaleString(undefined, {
    timeZoneName: "short" // ‚Üê affiche GMT, CET, etc.
  });
}

  
/* ----------------------------
   DASHBOARD
---------------------------- */
async function loadUserUploads() {
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  if (!user) return;

  const { data: events } = await supabase
    .from("events")
    .select("*")
    .eq("user_id", user.id)
    .eq("deleted", false)
    .order("uploaded_at", { ascending: false });

  const container = document.getElementById("eventsContainer");
  container.innerHTML = "";

  if (!events?.length) {
    container.textContent = "Vous n'avez aucun √©v√©nement pour l'instant.";
    return;
  }

  events.forEach(e => {

    const card = document.createElement("div");
    card.style.background = "rgba(255,255,255,0.8)";
    card.style.borderRadius = "12px";
    card.style.padding = "1rem";
    card.style.boxShadow = "0 4px 8px rgba(0,0,0,0.1)";
    card.style.display = "flex";
    card.style.flexDirection = "column";
    card.style.gap = "0.5rem";

    const title = document.createElement("h4");
    title.textContent = e.username;
    title.style.margin = "0";
    title.style.fontFamily = "'Playfair Display', serif";
    title.style.color = "#2e1f17";
    card.appendChild(title);

    const date = document.createElement("div");
    date.textContent = "üìÖ " + new Date(e.uploaded_at).toLocaleString();
    date.style.fontSize = "0.9rem";
    card.appendChild(date);

    //
    // ‚¨áÔ∏è CSV DOWNLOAD / SIGNED
    //
    const csvLink = document.createElement("a");
    csvLink.textContent = "T√©l√©charger CSV";
    csvLink.style.display = "inline-block";
    csvLink.style.padding = "0.4rem 0.6rem";
    csvLink.style.background = "#f5eee5";
    csvLink.style.border = "1px solid #d0bfae";
    csvLink.style.borderRadius = "6px";
    csvLink.style.textDecoration = "none";
    csvLink.style.color = "#3e2f27";
    csvLink.style.fontWeight = "600";
    csvLink.style.fontSize = "0.9rem";

    if (!e.is_private && e.signed_url === null) {
      csvLink.href = `${SUPABASE_URL}/storage/v1/object/public/public-guests/guests_${e.username}.csv`;
      csvLink.target = "_blank";

    } else if (e.signed_url) {
      csvLink.href = e.signed_url;
      csvLink.target = "_blank";

    } else {
      // PRIV√â ‚Üí g√©n√©ration d'URL sign√©e
      csvLink.href = "#";
      csvLink.onclick = async () => {
        try {
          const session = await supabase.auth.getSession();
          const userId = session.data.session?.user.id;
          const signedUrl = await getPrivateCsv(e.username, e.event_password, userId);
          window.open(signedUrl, "_blank");
        } catch (err) {
          alert("Erreur r√©cup√©ration CSV priv√©: " + (err.message || err));
        }
      };
    }
    card.appendChild(csvLink);

    //
    // üîó Lien vers l‚Äô√©v√©nement
    //
    const link = document.createElement("a");
    link.href = `${window.location.origin}/events/tables.html?event=${encodeURIComponent(e.username)}`;
    link.textContent = "Lien √©v√©nement";
    link.style.display = "inline-block";
    link.style.padding = "0.4rem 0.6rem";
    link.style.background = "#f5eee5";
    link.style.border = "1px solid #d0bfae";
    link.style.borderRadius = "6px";
    link.style.textDecoration = "none";
    link.style.color = "#3e2f27";
    link.style.fontWeight = "600";
    link.style.fontSize = "0.9rem";
    link.style.marginTop = "0.5rem";
    link.target = "_blank";
    card.appendChild(link);

    //
    // üìä Google Sheet link
    //
    if (e.google_sheet_url) {
      const sheetLink = document.createElement("a");
      sheetLink.href = e.google_sheet_url;
      sheetLink.textContent = "üìä Google Sheet";
      sheetLink.target = "_blank";
      sheetLink.style.display = "inline-block";
      sheetLink.style.marginTop = "0.5rem";
      card.appendChild(sheetLink);
    }

    //
    // üîÑ SYNC BUTTON ‚Äî PRIVATE ONLY
    //
    if (e.google_sheet_url && e.is_private) {

     
      const syncOneBtn = document.createElement("button");
syncOneBtn.type = "button"; 

      syncOneBtn.textContent = "Sync CSV priv√©";
      syncOneBtn.style.marginTop = "0.5rem";

      syncOneBtn.onclick = async () => {

        const session = await supabase.auth.getSession();
        const accessToken = session.data.session?.access_token;
        if (!accessToken) return alert("‚ùå Connecte-toi.");

        syncOneBtn.textContent = "Sync...";
        syncOneBtn.disabled = true;

        try {
          const res = await fetch(
            
            `${SUPABASE_URL}/functions/v1/sync-privatesheet-csv`,
            {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                event_id: e.id,
                username: e.username,
                google_sheet_url: e.google_sheet_url,
                password: e.event_password
              })
            }
          );

          // certains retours ne sont pas JSON ‚Üí protection
          let data = {};
          try {
            const t = await res.text();
            data = t ? JSON.parse(t) : {};
          } catch {}

          if (!res.ok) {
            throw new Error(
              data.error || data.message || "Unknown sync error"
            );
          }

          alert("‚úÖ CSV priv√© synchronis√© !");
         
await loadUserUploads(); 

        } catch (err) {
          alert("‚ùå Sync error : " + err.message);
        } finally {
          syncOneBtn.textContent = "Sync CSV priv√©";
          syncOneBtn.disabled = false;
        }
      };

      card.appendChild(syncOneBtn);

      //
      // üïí Info derni√®re sync
      //
      if (e.updated_at) {
        const syncInfo = document.createElement("div");
        syncInfo.textContent =
          "üîÑ Derni√®re sync : " +formatDateWithTimeZone(e.updated_at);

        syncInfo.style.fontSize = "0.85rem";
        syncInfo.style.color = "#444";
        card.appendChild(syncInfo);
      }
    }

    //
    // FIN : on ajoute la carte au container
    //
    container.appendChild(card);
// üóëÔ∏è Bouton suppression (soft delete)
const deleteBtn = document.createElement("button");
deleteBtn.textContent = "üóëÔ∏è Supprimer l'√©v√©nement";
deleteBtn.style.marginTop = "0.4rem";
deleteBtn.style.fontSize = "0.8rem";
deleteBtn.style.padding = "4px 8px";
deleteBtn.style.border = "1px solid #ccc";
deleteBtn.style.borderRadius = "4px";
deleteBtn.style.background = "#f5f5f5";
deleteBtn.style.color = "#555";
deleteBtn.style.cursor = "pointer";
deleteBtn.onmouseenter = () => deleteBtn.style.background = "#e7e7e7";
deleteBtn.onmouseleave = () => deleteBtn.style.background = "#f5f5f5";
deleteBtn.onclick = async () => {
  if (!confirm("Voulez-vous vraiment supprimer cet √©v√©nement ?")) return;

  const { error } = await supabase.rpc("soft_delete_event", { event_id: e.id });
  if (error) return alert("Erreur suppression: " + error.message);
  
  alert("√âv√©nement supprim√© !");
  loadUserUploads();
};
card.appendChild(deleteBtn);

    // ‚ùå Suppression d√©finitive
const deleteForeverBtn = document.createElement("button");
deleteForeverBtn.textContent = "üî• Supprimer d√©finitivement";
deleteForeverBtn.style.marginTop = "0.2rem";
deleteForeverBtn.style.fontSize = "0.75rem";
deleteForeverBtn.style.padding = "3px 6px";
deleteForeverBtn.style.border = "1px solid #e3c1c1";
deleteForeverBtn.style.borderRadius = "4px";
deleteForeverBtn.style.background = "#faf4f4";
deleteForeverBtn.style.color = "#a55";
deleteForeverBtn.style.cursor = "pointer";
deleteForeverBtn.style.opacity = "0.8";

deleteForeverBtn.onmouseenter = () => {
  deleteForeverBtn.style.opacity = "1";
  deleteForeverBtn.style.background = "#f1e2e2";
};
deleteForeverBtn.onmouseleave = () => {
  deleteForeverBtn.style.opacity = "0.8";
  deleteForeverBtn.style.background = "#faf4f4";
};

deleteForeverBtn.onclick = async () => {
  if (!confirm("‚ö†Ô∏è SUPPRESSION D√âFINITIVE\nTout sera supprim√©. Continuer ?")) return;
  if (!confirm("üíÄ Derni√®re chance ! Es-tu s√ªr ?")) return;

  const session = await supabase.auth.getSession();
  const accessToken = session.data.session?.access_token;

  const res = await fetch(`${SUPABASE_URL}/functions/v1/delete-event`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${accessToken}`
    },
    body: JSON.stringify({ event_id: e.id, username: e.username })
  });

  if (res.ok) {
    alert("üî• √âv√©nement totalement supprim√© !");
    loadUserUploads();
  } else {
    const err = await res.json();
    alert("Erreur suppression compl√®te : " + err.error);
  }
};

card.appendChild(deleteForeverBtn);


  });

}
</script>

</body>
</html>
