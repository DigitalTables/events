<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DigitalTables ‚Äì Gestion des tables invit√©s</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header>
  <div class="container">
    <div class="logo-title">
      <img src="images/Logo.jpg" alt="Logo DigitalTables" class="logo" />
      <h1>DigitalTables</h1>
    </div>
  </div>
</header>

<section class="hero">
  <div class="container">
    <h2>Attribuez facilement la table de vos invit√©s</h2>
    <p>Import CSV ou Google Sheet ‚Ä¢ √âv√©nement public ou priv√©</p>
  </div>
</section>

<div style="text-align:center; margin-top:1rem;">
  <button id="logout" style="display:none; max-width:300px;">Se d√©connecter</button>
</div>

<section id="auth">
  <div class="container" style="max-width:480px;">
    <h3 style="text-align:center;">Connexion / Inscription</h3>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Mot de passe" />
    <button id="signup">Cr√©er un compte</button>
    <button id="login">Se connecter</button>
  </div>
</section>

<section id="dashboard" style="display:none;">
  <div class="container">
    <h3 style="text-align:center;">Mes √©v√©nements</h3>
    <div id="eventsContainer" class="dashboard-grid"></div>
  </div>
</section>

<section id="upload" style="display:none;">
  <div class="container" style="max-width:720px;">

    <h3 style="text-align:center;">Cr√©er un √©v√©nement</h3>

    <label>Identifiant public (URL)</label>
    <input type="text" id="username" placeholder="ex : mariage-anne-2026" />
    <div id="usernameStatus" class="hint"></div>

    <hr style="margin:2rem 0;">

    <strong>Visibilit√© de l‚Äô√©v√©nement</strong>
    <label style="display:block; margin-top:0.5rem;">
      <input type="checkbox" id="privateCsv" />
      √âv√©nement priv√© (acc√®s par mot de passe)
    </label>

    <div id="passwordDiv" style="display:none; margin-top:0.75rem;">
      <input type="password" id="eventPassword" placeholder="Mot de passe de l‚Äô√©v√©nement" />
    </div>

    <hr style="margin:2rem 0;">

    <strong>Source des invit√©s</strong>

    <div class="mode-selector">
      <label>
        <input type="radio" name="mode" id="modeCsv" checked />
        üìÑ Import CSV
      </label>
      <label>
        <input type="radio" name="mode" id="modeSheet" />
        üìä Google Sheet
      </label>
    </div>

    <h4 id="uploadTitle">Importer votre fichier CSV</h4>
    <input type="file" id="guests" accept=".csv" />

    <hr style="margin:2rem 0;">

    <h4>Images par table (optionnel)</h4>
    <p style="font-size:0.9rem; color:#6b5a4a;">
      Vous pouvez associer une image √† certaines tables (facultatif).
    </p>

    <div id="tableImageRows"></div>

    <button id="addTableImageRow" style="max-width:260px; margin-bottom:2rem;">
      ‚ûï Ajouter une table
    </button>

    <hr style="margin:2.5rem 0;">

    <div style="text-align:center;">
      <p style="font-weight:600; margin-bottom:0.5rem;">Une fois tout pr√™t :</p>
      <button id="createEventBtn" style="max-width:360px; font-size:1.1rem;">
        ‚úÖ Cr√©er l‚Äô√©v√©nement
      </button>
    </div>

    <div id="publicUrl" class="hint" style="margin-top:1rem; text-align:center;"></div>

  </div>
</section>

<footer>
  <div class="container">
    <p>¬© 2025 DigitalTables. Tous droits r√©serv√©s.</p>
  </div>
</footer>

<script type="module">
import { supabase, SUPABASE_URL } from './supabase.js';
import Papa from "https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";

/* DOM */
const tableImageRows = document.getElementById("tableImageRows");
const addTableImageRowBtn = document.getElementById("addTableImageRow");
let editingEvent = null;

/* TABLE IMAGES */
function addTableImageRow(tableName = "") {
  const div = document.createElement("div");
  div.style.marginBottom = "0.5rem";

  div.innerHTML = `
    <input type="text" placeholder="Nom de la table" value="${tableName}" />
    <input type="file" accept="image/*" />
    <button type="button">‚ùå</button>
  `;

  div.querySelector("button").onclick = () => div.remove();
  tableImageRows.appendChild(div);
}

addTableImageRowBtn.onclick = addTableImageRow;

/* ‚úÖ CORRECTION IMAGES ‚Äî CONSERVATION EN √âDITION */
async function uploadImagesMapping(username, existingMapping = {}) {
  const rows = tableImageRows.querySelectorAll("div");
  const mapping = { ...existingMapping };

  for (const row of rows) {
    const tableInput = row.querySelector("input[type='text']");
    const fileInput = row.querySelector("input[type='file']");

    if (!tableInput || !fileInput) continue;

    const tableName = tableInput.value.trim();
    const file = fileInput.files[0];

    if (!tableName) continue;
    if (!file) continue;

    const safeTableName = tableName
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9-_]/g, "-");

    const extension = file.name.split(".").pop();
    const filePath = `${username}/${safeTableName}.${extension}`;

    const { error } = await supabase.storage
      .from("images")
      .upload(filePath, file, { upsert: true });

    if (error) {
      throw new Error("Erreur upload image table : " + error.message);
    }

    mapping[tableName] = filePath;
  }

  return mapping;
}
</script>

</body>
</html>
