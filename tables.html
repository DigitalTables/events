<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Placement des invit√©s</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background: radial-gradient(ellipse at center, #fffdfb 0%, #f5eee5 100%); font-family: "Quicksand", sans-serif; text-align:center; padding:2em; color:#3e2f27; }
    h1,h2 { font-family:"Playfair Display", serif; color:#2e1f17; }
    input { width:300px; padding:10px; font-size:16px; }
    .result { margin-top:20px; font-size:18px; background-color: rgba(255,255,255,0.6); padding:1em; border-radius:8px; }
    .match-btn { background:#f5eee5; border:1px solid #d0bfae; border-radius:25px; padding:10px 18px; margin:6px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="logo-container">
    <img src="./images/Logo.jpg" alt="Logo" class="logo-image">
  </div>
  <h1>Bienvenue √† votre √©v√©nement</h1>
  <h2>Recherchez votre table</h2>
  <p>Entrez votre nom pour conna√Ætre votre table</p>
  <input type="text" id="nameInput" list="names" placeholder="Commencez √† √©crire..." />
  <datalist id="names"></datalist>
  <div id="result" class="result"></div>

  <script type="module">
import { supabase, getPrivateCsv } from './supabase.js';
const resultEl = document.getElementById("result");
const inputEl = document.getElementById("nameInput");
const datalistEl = document.getElementById("names");
const defaultMessage = "Merci pour votre pr√©sence avec nous !";
let guests = [];
const params = new URLSearchParams(window.location.search);
const eventUsername = params.get("event");

if(!eventUsername) { resultEl.textContent="Aucun identifiant d‚Äô√©v√©nement fourni."; }
else { loadEvent(eventUsername); }

async function loadEvent(username){
  const { data, error } = await supabase.from("events").select("*").eq("username",username).single();
  if(error || !data){ resultEl.textContent="‚ùå √âv√©nement introuvable."; return; }

  if(data.is_private){
    const pwd = prompt("üîí Cet √©v√©nement est priv√©. Entrez le mot de passe :");
    if(!pwd || pwd!==data.event_password){ resultEl.textContent="‚ùå Mot de passe incorrect."; return; }
    const session = await supabase.auth.getSession();
    const userId = session.data.session?.user.id;
    if(!userId) return resultEl.textContent="‚ùå Connecte-toi pour voir cet √©v√©nement.";
    const csvUrl = await getPrivateCsv(`guests_${username}.csv`);
 
    console.log("URL CSV priv√© :", res);
const csvText = await fetch(res).then(r => r.text());
console.log("Contenu CSV :", csvText);

const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
guests = parsed.data;
fillDatalist();
console.log("‚úÖ Invit√©s charg√©s (CSV priv√©) :", guests.length);


    guests = Papa.parse(csvText,{header:true,skipEmptyLines:true}).data;
  } else {
    const jsonUrl = `${supabase.supabaseUrl}/storage/v1/object/public/public-guests/guests_${username}.json`;
    const res = await fetch(jsonUrl);
    guests = await res.json();
  }
  fillDatalist();
}

function normalize(str){return String(str||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim();}
function fillDatalist(){datalistEl.innerHTML=""; guests.forEach(g=>{const opt=document.createElement("option"); opt.value=g.name; datalistEl.appendChild(opt);});}
function showGuest(guest){ let html=`<span>${guest.message||defaultMessage}<br><br><strong>Votre table :</strong> ${guest.table}</span>`; const img = tableImages[guest.table]; if(img) html+=`<br><img src="${img}" alt="Image ${guest.table}">`; resultEl.innerHTML=html;}
function showNoMatch(input){resultEl.textContent=`Aucun invit√© reconnu pour "${input}".`;}
function showMultiple(matches){ const items = matches.slice(0,8).map(m=>`<button type="button" class="match-btn" data-name="${m.name}">${m.name}</button>`).join(""); resultEl.innerHTML=`<div>Plusieurs correspondances :<br>${items}</div>`;}
function searchAndDisplay(input){ if(!input||input.trim()===""){resultEl.textContent=""; return;} const n=normalize(input); let matches=guests.filter(g=>normalize(g.name)===n); if(matches.length===1) return showGuest(matches[0]); matches=guests.filter(g=>normalize(g.name).startsWith(n)); if(matches.length>=1) return showMultiple(matches); matches=guests.filter(g=>normalize(g.name).includes(n)); if(matches.length>=1) return showMultiple(matches); showNoMatch(input);}
inputEl.addEventListener("input", e=>searchAndDisplay(e.target.value));
inputEl.addEventListener("change", e=>searchAndDisplay(e.target.value));
resultEl.addEventListener("click", e=>{ const name = e.target.dataset?.name; if(name){ inputEl.value=name; const guest=guests.find(g=>normalize(g.name)===normalize(name)); if(guest) showGuest(guest); } });

const tableImages = {
  "Whale sharks - Nabire":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Requinsbaleine.jpeg",
  "Machu Picchu - Per√∫":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/MachuPicchu.jpeg",
  "Isle of Skye - Scotland":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Scotland.jpeg",
  "Piton des Neiges - La R√©union":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Reunion.jpeg",
  "Komodo Dragons - Indonesia":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Komodo.jpeg",
  "Backside Mont Fort - Verbier":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Montfort.jpeg",
  "Heliski Ch√¢teau des Dames - Cervinia":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Heliski.jpeg",
  "Halong Bay Cruise - Vietnam":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Halongbay.jpeg",
  "Hammerhead Sharks - Galapagos":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Galapagos.jpeg",
  "Mitad del mundo - Ecuador":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Mitaddelmundo.jpeg",
  "3 of Us - Mauritius":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Maurice.jpeg",
  "Colle dell'Arietta - Valle Soana":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Arietta.jpeg",
  "Niseko Powder - Japan":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Niseko.jpeg",
  "La Demande - Santorini":"https://raw.githubusercontent.com/willisandlionel/tables/main/images/Santorini.jpeg"
};
</script>

</body>
</html>
