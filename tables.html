<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Placement des invit√©s</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script type="module">
    import { supabase, getPrivateCsv } from './supabase.js';

    const resultEl = document.getElementById("result");
    const inputEl = document.getElementById("nameInput");
    const datalistEl = document.getElementById("names");
    let guests = [];

    const params = new URLSearchParams(window.location.search);
    const eventUsername = params.get("event");

    if (!eventUsername) {
      resultEl.textContent = "Aucun identifiant d‚Äô√©v√©nement fourni dans l‚ÄôURL.";
    } else {
      loadEvent(eventUsername);
    }

    async function loadEvent(username) {
      const { data, error } = await supabase.from("events").select("*").eq("username", username).single();
      if (error || !data) return resultEl.textContent = "‚ùå √âv√©nement introuvable.";

      if (data.is_private) {
        const pwd = prompt("üîí Cet √©v√©nement est priv√©. Entrez le mot de passe :");
        if (!pwd) return resultEl.textContent = "‚ùå Mot de passe requis.";

        try {
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) return resultEl.textContent = "Veuillez vous connecter pour acc√©der √† cet √©v√©nement.";
          const csvUrl = await getPrivateCsv(username, pwd, user.id);
          loadPrivateCsv(csvUrl);
        } catch (err) {
          resultEl.textContent = "Erreur d‚Äôacc√®s au fichier priv√© : " + err.message;
        }
      } else {
        const jsonUrl = `https://xrffjwulhrydrhlvuhlj.supabase.co/storage/v1/object/public/public-guests/guests_${username}.json`;
        loadPublicJson(jsonUrl);
      }
    }

    async function loadPublicJson(url) {
      const res = await fetch(url);
      guests = await res.json();
      fillDatalist();
    }

    async function loadPrivateCsv(url) {
      const res = await fetch(url);
      const text = await res.text();
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      guests = parsed.data;
      fillDatalist();
    }

    function fillDatalist() {
      datalistEl.innerHTML = "";
      guests.forEach((g) => {
        const opt = document.createElement("option");
        opt.value = g.name;
        datalistEl.appendChild(opt);
      });
    }

    function normalize(str) {
      return String(str || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
    }

    inputEl.addEventListener("input", () => {
      const val = normalize(inputEl.value);
      const match = guests.find((g) => normalize(g.name) === val);
      resultEl.innerHTML = match
        ? `<strong>${match.name}</strong><br>Table : ${match.table}<br>Message : ${match.message || "Bienvenue !"}`
        : "Invit√© non trouv√©.";
    });
  </script>

  <style>
    body { background: radial-gradient(ellipse at center, #fffdfb 0%, #f5eee5 100%); font-family: "Quicksand", sans-serif; text-align:center; padding:2em; color:#3e2f27; }
    h1,h2 { font-family:"Playfair Display",serif; color:#2e1f17; }
    input { width:300px; padding:10px; font-size:16px; }
    .result { margin-top:20px; font-size:18px; background-color:rgba(255,255,255,0.6); padding:1em; border-radius:8px; }
  </style>
</head>
<body>
  <img src="./images/Logo.jpg" alt="Logo" style="max-width:150px;" />
  <h1>Bienvenue √† votre √©v√©nement</h1>
  <h2>Recherchez votre table</h2>
  <input type="text" id="nameInput" list="names" placeholder="Votre nom..." />
  <datalist id="names"></datalist>
  <div id="result" class="result"></div>
</body>
</html>
