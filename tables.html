<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Placement des invit√©s</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      background: radial-gradient(ellipse at center, #fffdfb 0%, #f5eee5 100%);
      font-family: "Quicksand", sans-serif;
      text-align: center;
      padding: 2em;
      color: #3e2f27;
    }
    h1, h2 { font-family: "Playfair Display", serif; color: #2e1f17; }
    input { width: 300px; padding: 10px; font-size: 16px; }
    .result { margin-top: 20px; font-size: 18px; background-color: rgba(255,255,255,0.6); padding: 1em; border-radius: 8px; }
    .match-btn { background: #f5eee5; border: 1px solid #d0bfae; border-radius: 25px; padding: 10px 18px; margin: 6px; cursor: pointer; }
    .logo-container img { max-width: 200px; margin-bottom: 1em; }
    img { max-width: 300px; margin-top: 1em; border-radius: 8px; }
  </style>
</head>
<body>

<div class="logo-container">
  <img src="./images/Logo.jpg" alt="Logo DigitalTables" class="logo-image">
</div>
<h1>Bienvenue √† votre √©v√©nement</h1>
<h2>Recherchez votre table</h2>
<p>Entrez votre nom pour conna√Ætre votre table</p>

<input type="text" id="nameInput" list="names" placeholder="Commencez √† √©crire..." />
<datalist id="names"></datalist>

<div id="result" class="result">
  Commencez √† taper votre nom pour voir votre table.
</div>

<script type="module">
import { supabase, getPrivateCsv, getEventImagesMapping } from './supabase.js';

const resultEl = document.getElementById("result");
const inputEl = document.getElementById("nameInput");
const datalistEl = document.getElementById("names");
const defaultMessage = "Merci pour votre pr√©sence avec nous !";
let guests = [];
let imagesMapping = {};

// Param√®tre event dans l'URL
const params = new URLSearchParams(window.location.search);
const eventUsername = params.get("event");

if (!eventUsername) {
  resultEl.textContent = "Aucun identifiant d‚Äô√©v√©nement fourni dans l‚ÄôURL.";
} else {
  loadEvent(eventUsername);
}

async function loadEvent(username) {
  const { data, error } = await supabase
    .from("events")
    .select("*")
    .eq("username", username)
    .single();

  if (error || !data) {
    resultEl.textContent = "‚ùå √âv√©nement introuvable.";
    console.error(error);
    return;
  }

  imagesMapping = data.images_mapping || {};

  const publicJsonUrl = `${supabase.supabaseUrl}/storage/v1/object/public/public-guests/guests_${username}.json`;

  // ‚≠ê NEW ‚Äî test si le JSON public existe
  let publicJsonExists = false;
  try {
    const test = await fetch(publicJsonUrl, { method: "HEAD" });
    publicJsonExists = test.ok;
  } catch (_) {}

  // üéØ CAS PUBLIC (CSV ou Google Sheet public)
  if (!data.is_private) {
    if (publicJsonExists) {
      guests = await fetch(publicJsonUrl).then(r => r.json());
      fillDatalist();
      return;
    }
  else if (data.google_sheet_url) {
  try {
    const sheetIdMatch = data.google_sheet_url.match(/\/d\/([a-zA-Z0-9-_]+)/);
const sheetId = sheetIdMatch ? sheetIdMatch[1] : null;
const sheetCsvUrl = sheetId ? `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0` : null;
if (!sheetCsvUrl) throw new Error("Impossible de g√©n√©rer l'URL CSV depuis la Google Sheet.");
    console.log("url google sheet: ",sheetCsvUrl);
    const csvText = await fetch(sheetCsvUrl).then(r => {
      if (!r.ok) throw new Error("Impossible de charger la Google Sheet publique.");
      return r.text();
    });
    const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    guests = parsed.data.filter(g => g.name); // filtrer lignes vides
    fillDatalist();
    console.log("‚úÖ Invit√©s charg√©s depuis Google Sheet publique :", guests.length);
    return; 
  } catch(e) {
    console.error(e);
    resultEl.textContent = "Erreur chargement Google Sheet publique : " + e.message;
    return;
  }
}
    resultEl.textContent = "Erreur : fichier public introuvable.";
    return;
  }

  // üéØ CAS PRIV√â (CSV priv√© ou Google Sheet priv√© avant/apr√®s sync)
  const pwd = prompt("üîí Cet √©v√©nement est priv√©. Entrez le mot de passe :");
  if (!pwd || pwd !== data.event_password) {
    resultEl.textContent = "‚ùå Mot de passe incorrect.";
    return;
  }

  try {
    const session = await supabase.auth.getSession();
    const userId = session.data.session?.user.id;
    if (!userId) throw new Error("Utilisateur non connect√©");

    // ‚≠ê NEW ‚Äî si Google Sheet priv√© a √©t√© sync ‚Üí JSON n'existe PAS mais CSV priv√© OUI
    const signedUrl = await getPrivateCsv(username, pwd, userId);

    const csvText = await fetch(signedUrl).then(r => r.text());
    const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    guests = parsed.data;
    fillDatalist();
    console.log("Invit√©s charg√©s (CSV priv√© ou sync)");
  } catch(e) {
    console.error(e);
    resultEl.textContent = "Erreur chargement CSV priv√© : " + e.message;
  }
}

function normalize(str) {
  return String(str || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

function fillDatalist() {
  datalistEl.innerHTML = "";
  guests.forEach(g => {
    const opt = document.createElement("option");
    opt.value = g.name;
    datalistEl.appendChild(opt);
  });
}

function showGuest(guest) {
  const message = guest.message || defaultMessage;
  let html = `<span style="color: inherit;">${message}<br><br><strong>Votre table est :</strong> ${guest.table}</span>`;
  const imgPath = imagesMapping[guest.table];
  if (imgPath) {
    const imgUrl = `${supabase.supabaseUrl}/storage/v1/object/public/images/${imgPath}`;
    html += `<br><img src="${imgUrl}" alt="Image de la table ${guest.table}">`;
  }
  resultEl.innerHTML = html;
}

function showNoMatch(input) {
  resultEl.textContent = `Aucun invit√© reconnu pour "${input}".`;
}

function showMultiple(matches) {
  const items = matches.slice(0, 8)
    .map(m => `<button type="button" class="match-btn" data-name="${m.name}">${m.name}</button>`)
    .join("");
  resultEl.innerHTML = `<div>Plusieurs correspondances :<br>${items}</div>`;
}

function searchAndDisplay(input) {
  if (!input || input.trim() === "") { resultEl.textContent = "Commencez √† taper votre nom pour voir votre table."; return; }
  const n = normalize(input);
  let matches = guests.filter(g => normalize(g.name) === n);
  if (matches.length === 1) return showGuest(matches[0]);
  matches = guests.filter(g => normalize(g.name).startsWith(n));
  if (matches.length >= 1) return showMultiple(matches);
  matches = guests.filter(g => normalize(g.name).includes(n));
  if (matches.length >= 1) return showMultiple(matches);
  showNoMatch(input);
}

inputEl.addEventListener("input", e => searchAndDisplay(e.target.value));
inputEl.addEventListener("change", e => searchAndDisplay(e.target.value));

resultEl.addEventListener("click", e => {
  const name = e.target.dataset?.name;
  if (name) {
    inputEl.value = name;
    const guest = guests.find(g => normalize(g.name) === normalize(name));
    if (guest) showGuest(guest);
  }
});
</script>
</body>
</html>
