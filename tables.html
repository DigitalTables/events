<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Placement des invit√©s</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="logo-container">
    <img src="images/LogoWlNoBck.png" alt="Logo DigitalTables" class="logo-image">
  </div>

  <h1>Bienvenue / Benvenuta, Benvenuto / Welcome</h1>
  <h2 id="event-title">Chargement...</h2>
  <h3>Pour conna√Ætre ta table, per conoscere il tuo tavolo</h3>

  <p>Entre ton nom :</p>
  <input type="text" id="nameInput" list="names" placeholder="Commencez √† taper...">
  <datalist id="names"></datalist>
  <div class="result" id="result"></div>

  <!-- Charge supabase.js (d√©j√† configur√©) -->
  <script type="module" src="supabase.js"></script>

  <script type="module">
    // On r√©cup√®re le client Supabase d√©j√† cr√©√© dans supabase.js
    const supabase = window.supabase;

    const params = new URLSearchParams(window.location.search);
    const username = params.get('user');
    const inputEl = document.getElementById('nameInput');
    const resultEl = document.getElementById('result');
    const titleEl = document.getElementById('event-title');
    let guests = [];
    const defaultMessage = "Nous sommes ravis que tu sois parmi nous, place √† la f√™te!";

    if (!username) {
      titleEl.textContent = "‚ùå Aucun √©v√©nement sp√©cifi√© dans l'URL.";
    } else {
      loadEvent(username);
    }

    // ============================
    // üîπ Chargement de l'√©v√©nement
    // ============================
    async function loadEvent(username) {
      titleEl.textContent = `√âv√©nement : ${username}`;
      resultEl.textContent = "Chargement des invit√©s...";

      const { data: event, error } = await supabase
        .from('events')
        .select('*')
        .eq('username', username)
        .maybeSingle();

      if (error || !event) {
        resultEl.textContent = "‚ùå Aucun √©v√©nement trouv√©.";
        return;
      }

      // Si l‚Äô√©v√©nement est priv√©, demander le mot de passe
      if (event.event_password) {
        const pwd = prompt("üîí Cet √©v√©nement est priv√©. Entrez le mot de passe :");
        if (pwd !== event.event_password) {
          resultEl.textContent = "‚ùå Mot de passe incorrect.";
          return;
        }
      }

      try {
        // Cas 1Ô∏è‚É£ : √âv√©nement priv√© ‚Üí fichier CSV via URL sign√©e
        if (event.event_password && event.signed_url) {
          const response = await fetch(event.signed_url);
          const csvText = await response.text();
          guests = csvToJson(csvText);
        }

        // Cas 2Ô∏è‚É£ : √âv√©nement public ‚Üí JSON public
        else {
          const publicJsonUrl = `https://xrffjwulhrydrhlvuhlj.supabase.co/storage/v1/object/public/public-guests/guests_${username}.json`;
          const response = await fetch(publicJsonUrl);
          if (!response.ok) throw new Error("JSON public introuvable");
          guests = await response.json();
        }

        fillDatalist();
        resultEl.textContent = "‚úÖ Liste des invit√©s charg√©e !";

      } catch (err) {
        resultEl.textContent = "‚ùå Erreur de chargement : " + err.message;
      }
    }

    // ============================
    // üîπ Conversion CSV ‚Üí JSON
    // ============================
    function csvToJson(csvText) {
      const [headerLine, ...lines] = csvText.split(/\r?\n/).filter(Boolean);
      const headers = headerLine.split(",").map(h => h.trim());
      return lines.map(line => {
        const values = line.split(",").map(v => v.trim());
        return Object.fromEntries(headers.map((h, i) => [h, values[i]]));
      });
    }

    // ============================
    // üîπ Interface & recherche
    // ============================
    function fillDatalist() {
      const dl = document.getElementById('names');
      dl.innerHTML = '';
      guests.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.name;
        dl.appendChild(opt);
      });
    }

    const tableImages = {
      "Whale sharks - Nabire": "https://raw.githubusercontent.com/willisandlionel/tables/main/images/Requinsbaleine.jpeg",
      "Machu Picchu - Per√∫": "https://raw.githubusercontent.com/willisandlionel/tables/main/images/MachuPicchu.jpeg",
      // tu peux en ajouter d'autres ici
    };

    function normalize(str) {
      return String(str || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function showGuest(guest) {
      const message = guest.message || defaultMessage;
      let html = `<span>${message}<br><br><strong>Ta table est :</strong> ${guest.table}</span>`;
      const img = tableImages[guest.table];
      if (img) html += `<br><img src="${img}" alt="Image de la table ${guest.table}">`;
      resultEl.innerHTML = html;
    }

    function showNoMatch(input) {
      resultEl.textContent = `Aucun invit√© reconnu pour "${input}".`;
    }

    function showMultiple(matches) {
      const items = matches.slice(0, 8).map(m =>
        `<button type="button" class="match-btn" data-name="${m.name}">${m.name}</button>`
      ).join('');
      resultEl.innerHTML = `<div>Plusieurs correspondances :<br>${items}</div>`;
    }

    function searchAndDisplay(input) {
      if (!input.trim()) {
        resultEl.textContent = '';
        return;
      }
      const n = normalize(input);
      let matches = guests.filter(g => normalize(g.name) === n);
      if (matches.length === 1) { showGuest(matches[0]); return; }
      matches = guests.filter(g => normalize(g.name).startsWith(n));
      if (matches.length >= 1) { showMultiple(matches); return; }
      matches = guests.filter(g => normalize(g.name).includes(n));
      if (matches.length >= 1) { showMultiple(matches); return; }
      showNoMatch(input);
    }

    inputEl.addEventListener('input', e => searchAndDisplay(e.target.value));
    inputEl.addEventListener('change', e => searchAndDisplay(e.target.value));

    resultEl.addEventListener('click', e => {
      const name = e.target.dataset && e.target.dataset.name;
      if (name) {
        inputEl.value = name;
        const guest = guests.find(g => normalize(g.name) === normalize(name));
        if (guest) showGuest(guest);
      }
    });
  </script>
</body>
</html>
