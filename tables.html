<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Placement des invités</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
  <style>
body {
  background: radial-gradient(ellipse at center, #fffdfb 0%, #f5eee5 100%);
  font-family: 'Quicksand', sans-serif;
  text-align: center;
  padding: 2em;
  color: #3e2f27;
}
h1, h2 {
  font-family: 'Playfair Display', serif;
  color: #2e1f17;
}
input {
  width: 300px;
  padding: 10px;
  font-size: 16px;
  font-family: 'Quicksand', sans-serif;
}
img {
  margin-top: 20px;
  width: 150px;
  height: 150px;
}
.logo-container {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 30px;
}
.logo-image {
  max-width: 250px;
  height: auto;
  opacity: 0.95;
  transition: transform 0.3s ease;
}
.logo-image:hover {
  transform: scale(1.05);
}
.result {
  margin-top: 20px;
  font-size: 18px;
  font-family: 'Quicksand', sans-serif;
  padding: 1em;
  max-width: 90%;
  margin-left: auto;
  margin-right: auto;
  background-color: rgba(255, 255, 255, 0.6);
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  word-wrap: break-word;
  color: #3e2f27;
}
.result * {
  color: inherit;
}
.result img {
  max-width: 100%;
  height: auto;
  margin-top: 1em;
  border-radius: 6px;
}
.match-btn {
  background: linear-gradient(135deg, #f5eee5 0%, #e7d8c7 100%);
  color: #3e2f27;
  border: 1px solid #d0bfae;
  border-radius: 25px;
  padding: 10px 18px;
  margin: 6px;
  font-size: 16px;
  font-family: 'Quicksand', sans-serif;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: all 0.25s ease;
}
.match-btn:hover {
  background: linear-gradient(135deg, #e7d8c7 0%, #f5eee5 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}
.match-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
  </style>
</head>
<body>
  <div class="logo-container">
    <img src="../images/Logo.jpg" alt="Logo" class="logo-image">
  </div>
  <h1>Bienvenue au</h1>
  <h2>Mariage de Louise et John</h2>
  <p>Entrez votre nom pour connaître votre table</p>
  <input type="text" id="nameInput" list="names" placeholder="Commencez à écrire...">
  <datalist id="names"></datalist>
  <div class="result" id="result"></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script type="module">
    import { supabase } from './supabase.js';

    const defaultMessage = "Merci pour votre présence avec nous !";
    const inputEl = document.getElementById('nameInput');
    const resultEl = document.getElementById('result');
    let guests = [];

    /* 1️⃣ Récupération automatique du CSV depuis Supabase */
    async function loadCsvFromSupabase() {
      try {
        // 1. Récupère le paramètre ?event=username dans l’URL
        const params = new URLSearchParams(window.location.search);
        const username = params.get('event');
        if (!username) {
          resultEl.textContent = "Erreur : aucun événement spécifié.";
          return;
        }

        // 2. Va chercher la ligne correspondante dans la table events
        const { data, error } = await supabase
          .from('events')
          .select('csv_path, signed_url, is_private')
          .eq('username', username)
          .single();

        if (error || !data) {
          console.error("Erreur chargement événement :", error);
          resultEl.textContent = "Erreur : événement introuvable.";
          return;
        }

        // 3. Récupère le CSV depuis le bucket (signed URL si privé)
        let csvUrl = data.is_private ? data.signed_url : `https://YOUR_PROJECT_ID.supabase.co/storage/v1/object/public/${data.csv_path}`;
        console.log("Chargement du CSV :", csvUrl);

        Papa.parse(csvUrl, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            guests = results.data;
            fillDatalist();
          },
          error: function(err) {
            console.error('Erreur CSV →', err);
            resultEl.textContent = 'Erreur de chargement CSV : ' + err.message;
          }
        });
      } catch (err) {
        console.error("Erreur générale CSV :", err);
        resultEl.textContent = "Erreur : impossible de charger la liste.";
      }
    }
