<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Placement des invités</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script type="module">
import { supabase, getPrivateCsv } from './supabase.js';

const resultEl = document.getElementById("result");
const inputEl = document.getElementById("nameInput");
const datalistEl = document.getElementById("names");
let guests = [];

const params = new URLSearchParams(window.location.search);
const username = params.get("event");
if (!username) { resultEl.textContent = "Aucun identifiant d’événement"; }

async function loadEvent(username) {
  const { data, error } = await supabase.from("events").select("*").eq("username", username).single();
  if (error || !data) { resultEl.textContent = "Événement introuvable"; return; }

  if (data.is_private) {
    const pwd = prompt("Mot de passe requis :");
    if (!pwd || pwd !== data.event_password) { resultEl.textContent = "Mot de passe incorrect"; return; }
    const csvPath = `guests_${username}.csv`;
    try {
      const signedUrl = await getPrivateCsv(csvPath);
      const csvText = await fetch(signedUrl).then(r=>r.text());
      guests = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;
    } catch(e) { resultEl.textContent = "Erreur CSV privé: " + e.message; return; }
  } else {
    try {
      const jsonUrl = `${supabase.supabaseUrl}/storage/v1/object/public/public-guests/guests_${username}.json`;
      const res = await fetch(jsonUrl); if(!res.ok) throw new Error("Impossible de charger JSON public");
      guests = await res.json();
    } catch(e) { resultEl.textContent = "Erreur JSON public: "+e.message; return; }
  }
  fillDatalist();
}

function normalize(str){ return String(str||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim(); }

function fillDatalist(){
  datalistEl.innerHTML="";
  guests.forEach(g=>{ const opt=document.createElement("option"); opt.value=g.name; datalistEl.appendChild(opt); });
}

inputEl.addEventListener("input",e=>searchDisplay(e.target.value));
inputEl.addEventListener("change",e=>searchDisplay(e.target.value));

function searchDisplay(input){
  if(!input.trim()){ resultEl.textContent=""; return; }
  const n = normalize(input);
  const matches = guests.filter(g=>normalize(g.name)===n);
  if(matches.length===1){ showGuest(matches[0]); return; }
  const partial = guests.filter(g=>normalize(g.name).startsWith(n) || normalize(g.name).includes(n));
  if(partial.length>=1){ showMultiple(partial); return; }
  resultEl.textContent = `Aucun invité reconnu pour "${input}"`;
}

function showGuest(g){ resultEl.innerHTML = `<strong>Table :</strong> ${g.table}<br>${g.message||""}`; }
function showMultiple(ms){ resultEl.innerHTML = ms.slice(0,8).map(m=>`<button data-name="${m.name}">${m.name}</button>`).join(""); }
resultEl.addEventListener("click", e=>{
  const name = e.target.dataset?.name;
  if(name){ inputEl.value=name; const g=guests.find(g=>normalize(g.name)===normalize(name)); if(g)showGuest(g); }
});

if(username) loadEvent(username);
</script>

<input type="text" id="nameInput" list="names" placeholder="Commencez à écrire..."/>
<datalist id="names"></datalist>
<div id="result"></div>
</body>
</html>
